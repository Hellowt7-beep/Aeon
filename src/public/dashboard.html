<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aeon AI Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" id="highlight-theme" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');

        :root[data-theme="light"] {
            --bg-primary: #f9f9fb;
            --bg-secondary: rgba(255, 255, 255, 0.7);
            --bg-tertiary: rgba(248, 248, 248, 0.9);
            --bg-chat: #fefefe;
            --text-primary: #0b0b0f;
            --text-secondary: #6b6b6f;
            --border-color: rgba(0, 0, 0, 0.08);
            --hover-bg: rgba(0, 0, 0, 0.04);
            --accent-color: #111111;
            --surface-muted: rgba(0, 0, 0, 0.03);
            --code-bg: #f2f2f2;
            --shadow: 0 20px 60px rgba(15, 15, 20, 0.1);
            --sidebar-bg: rgba(255, 255, 255, 0.65);
            --input-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(0, 0, 0, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.7);
            --typing-star-color: linear-gradient(120deg, #a855f7, #4ade80);
            --action-bg: #0b0b0f;
            --action-text: #fefefe;
        }

        :root[data-theme="dark"] {
            --bg-primary: #050505;
            --bg-secondary: rgba(12, 12, 18, 0.85);
            --bg-tertiary: rgba(20, 20, 28, 0.95);
            --bg-chat: #0b0b11;
            --text-primary: #f4f4f5;
            --text-secondary: #9c9ca1;
            --border-color: rgba(255, 255, 255, 0.08);
            --hover-bg: rgba(255, 255, 255, 0.06);
            --accent-color: #fafafa;
            --surface-muted: rgba(255, 255, 255, 0.04);
            --code-bg: rgba(255, 255, 255, 0.04);
            --shadow: 0 25px 80px rgba(0, 0, 0, 0.55);
            --sidebar-bg: rgba(12, 12, 18, 0.92);
            --input-bg: rgba(255, 255, 255, 0.04);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --typing-star-color: linear-gradient(120deg, #a855f7, #4ade80);
            --action-bg: #fefefe;
            --action-text: #050505;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: 
                radial-gradient(circle at 20% 30%, rgba(102, 126, 234, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(168, 85, 247, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(91, 255, 160, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, var(--bg-primary) 0%, rgba(12, 12, 18, 0.98) 100%);
            background-size: 200% 200%, 200% 200%, 200% 200%, 100% 100%;
            background-position: 0% 0%, 100% 100%, 50% 50%, 0% 0%;
            animation: gradientShift 15s ease infinite;
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
            transition: background 0.3s ease, color 0.3s ease;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(102, 126, 234, 0.05) 0%, transparent 30%),
                radial-gradient(circle at 90% 80%, rgba(168, 85, 247, 0.05) 0%, transparent 30%);
            pointer-events: none;
            z-index: 0;
            animation: float 20s ease-in-out infinite;
        }

        body[data-font-size="small"] {
            font-size: 14px;
        }

        body[data-font-size="medium"] {
            font-size: 16px;
        }

        body[data-font-size="large"] {
            font-size: 18px;
        }

        body[data-contrast="high"] {
            filter: contrast(1.15) saturate(1.05);
        }

        /* Verbesserte Keyframe-Animationen */
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px) scale(0.98);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from { 
                transform: translateX(-100%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes scaleOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.95);
            }
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.7;
                transform: scale(1.05);
            }
        }

        @keyframes pulseSoft {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 5px var(--accent-color);
            }
            50% {
                box-shadow: 0 0 20px var(--accent-color), 0 0 30px var(--accent-color);
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes typing {
            from {
                width: 0;
            }
            to {
                width: 100%;
            }
        }

        @keyframes blink {
            0%, 50% {
                opacity: 1;
            }
            51%, 100% {
                opacity: 0;
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleInBounce {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes shimmerGlow {
            0% {
                box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.6), 0 0 30px rgba(168, 85, 247, 0.4);
            }
            100% {
                box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
            }
        }

        @keyframes rotateGradient {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Wiederverwendbare Animationsklassen */
        .animate-fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-fade-in-down {
            animation: fadeInDown 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-slide-in {
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-slide-in-right {
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-slide-up {
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-scale-in {
            animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-scale-out {
            animation: scaleOut 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .animate-bounce {
            animation: bounce 1s ease-in-out;
        }

        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }

        .animate-glow {
            animation: glow 2s ease-in-out infinite;
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .animate-shimmer {
            background: linear-gradient(
                90deg,
                var(--bg-tertiary) 0%,
                var(--hover-bg) 50%,
                var(--bg-tertiary) 100%
            );
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        /* Smooth Transitions */
        .transition-smooth {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .transition-fast {
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .transition-slow {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Ripple Effect f√ºr Buttons */
        .ripple-effect {
            position: relative;
            overflow: hidden;
        }

        .ripple-effect::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .ripple-effect:active::after {
            width: 300px;
            height: 300px;
        }

        .app-container {
            display: flex;
            height: 100vh;
            min-height: 0;
            overflow: hidden;
            padding: clamp(16px, 2vw, 32px);
            gap: 24px;
        }

        .sidebar {
            width: 280px;
            background: rgba(12, 12, 18, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px;
            display: flex;
            flex-direction: column;
            transition: transform 0.45s cubic-bezier(0.4, 0, 0.2, 1),
                        width 0.4s,
                        opacity 0.3s;
            z-index: 1000;
            animation: slideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(32px) saturate(180%);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.05) inset;
            position: relative;
            overflow: hidden;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(102, 126, 234, 0.4), 
                rgba(168, 85, 247, 0.4), 
                transparent);
        }

        .sidebar.collapsed {
            transform: translateX(-105%);
            opacity: 0;
        }

        body.sidebar-hidden .sidebar {
            transform: translateX(-105%);
            opacity: 0;
            width: 0;
            min-width: 0;
            pointer-events: none;
        }

        body.sidebar-hidden .sidebar-overlay {
            display: none;
        }

        body.sidebar-hidden .main-content {
            border-radius: 32px;
        }

        body.sidebar-hidden .app-container {
            gap: 0;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
        }

        .new-chat-btn {
            flex: 1;
            padding: 10px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .new-chat-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .new-chat-btn:hover {
            background: var(--hover-bg);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .new-chat-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .new-chat-btn:active {
            transform: translateY(0) scale(0.98);
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-toggle {
            padding: 10px;
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .sidebar-toggle:hover {
            background: var(--hover-bg);
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .sidebar-toggle:active {
            transform: scale(0.95);
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px 8px;
            min-height: 0;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .chat-item {
            padding: 14px 18px;
            margin-bottom: 6px;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 14px;
            animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) backwards;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid transparent;
        }

        .chat-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            transform: scaleY(0);
            transform-origin: bottom;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 0 4px 4px 0;
        }

        .chat-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            opacity: 0;
            transition: opacity 0.35s ease;
        }

        .chat-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(6px);
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .chat-item:hover::before {
            transform: scaleY(1);
        }

        .chat-item:hover::after {
            opacity: 1;
        }

        .chat-item.active {
            background: rgba(102, 126, 234, 0.15);
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 
                0 4px 16px rgba(102, 126, 234, 0.3),
                0 0 0 1px rgba(102, 126, 234, 0.2) inset;
        }

        .chat-item.active::before {
            transform: scaleY(1);
        }

        .chat-item.active::after {
            opacity: 1;
        }

        .chat-item-icon {
            font-size: 16px;
            opacity: 0.7;
        }

        .chat-item-content {
            flex: 1;
            min-width: 0;
        }

        .chat-item-title {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item-preview {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item-actions {
            display: none;
            gap: 4px;
            align-items: center;
        }

        .chat-item:hover .chat-item-actions {
            display: flex;
        }
        
        .chat-item-action {
            pointer-events: auto !important;
            z-index: 10;
            position: relative;
        }

        .chat-item-action {
            padding: 6px 10px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(0.9);
            opacity: 0;
            animation: scaleIn 0.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            pointer-events: auto !important;
            z-index: 10;
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            min-height: 32px;
            font-size: 14px;
        }

        .chat-item:hover .chat-item-action {
            opacity: 1;
            transform: scale(1);
        }

        .chat-item-action:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .chat-item-action:active {
            transform: scale(0.95);
        }
        
        .chat-item-action i {
            pointer-events: none;
        }

        .sidebar-footer {
            padding: 12px;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            min-height: fit-content;
        }

        .user-menu {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            min-height: fit-content;
            overflow: visible;
        }
        
        .user-role {
            white-space: normal;
            word-wrap: break-word;
            max-height: none;
            overflow: visible;
        }

        .user-menu:hover {
            background: var(--hover-bg);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-chat);
            position: relative;
            min-height: 0;
            border-radius: 32px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
            backdrop-filter: blur(30px);
        }

        .chat-header {
            min-height: 72px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            gap: 16px;
            backdrop-filter: blur(18px);
            background: rgba(0, 0, 0, 0.02);
        }

        .chat-title {
            font-size: 16px;
            font-weight: 500;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            padding: 8px 12px;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .header-btn:hover {
            background: var(--surface-muted);
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            border-color: var(--glass-border);
        }

        .header-btn:hover::before {
            width: 200px;
            height: 200px;
        }

        .header-btn:active {
            transform: translateY(0);
        }

        .header-btn.active {
            background: var(--surface-muted);
            border-color: var(--text-primary);
            color: var(--text-primary);
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
        }

        .theme-toggle {
            padding: 8px 12px;
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .theme-toggle:hover {
            background: var(--hover-bg);
            transform: rotate(180deg) scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .theme-toggle:active {
            transform: rotate(180deg) scale(0.95);
        }

        /* ? NEW: Grid View Toggle Button */
        .grid-view-toggle {
            padding: 8px 12px;
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .grid-view-toggle:hover {
            background: var(--hover-bg);
        }

        .grid-view-toggle.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        /* ? NEW: Chat Grid View */
        .chat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            padding: 24px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .chat-grid-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .chat-grid-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.1),
                transparent
            );
            transition: left 0.5s;
        }

        .chat-grid-item:hover {
            background: var(--hover-bg);
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 24px var(--shadow);
            border-color: var(--accent-color);
        }

        .chat-grid-item:hover::before {
            left: 100%;
        }

        .chat-grid-item:active {
            transform: translateY(-4px) scale(1);
        }

        .chat-grid-item-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .chat-grid-item-icon {
            font-size: 24px;
        }

        .chat-grid-item-title {
            font-size: 16px;
            font-weight: 600;
        }

        .chat-grid-item-preview {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .chat-grid-item-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        /* ? NEW: Image Generation UI */
        .image-gen-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 24px;
        }

        .image-gen-form {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .image-gen-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 16px;
        }

        .image-gen-options {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .image-gen-option {
            flex: 1;
            min-width: 150px;
        }

        .image-gen-option label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .image-gen-option select {
            width: 100%;
            padding: 8px 12px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .image-gen-button {
            width: 100%;
            padding: 14px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            color: #ffffff !important;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            animation: gradientShift 3s ease infinite;
        }

        .image-gen-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .image-gen-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .image-gen-button:hover::before {
            left: 100%;
        }

        .image-gen-button:active {
            transform: translateY(0);
        }

        .image-gen-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            animation: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .image-result {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            display: none;
        }

        .image-result.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .image-result img {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .image-result-prompt {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .image-result-actions {
            display: flex;
            gap: 8px;
        }

        .image-result-btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .image-result-btn:hover {
            background: var(--hover-bg);
        }

        /* ? NEW: Admin User Management */
        .admin-user-table {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .admin-user-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .admin-user-table th,
        .admin-user-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .admin-user-table th {
            background: var(--bg-tertiary);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .admin-user-table td {
            font-size: 14px;
        }

        .admin-user-table tr:last-child td {
            border-bottom: none;
        }

        .admin-user-table tr:hover {
            background: var(--hover-bg);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-online {
            background: rgba(16, 163, 127, 0.2);
            color: #10a37f;
        }

        .status-offline {
            background: rgba(180, 180, 180, 0.2);
            color: var(--text-secondary);
        }

        /* ... rest of existing styles ... */

        .chat-messages {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding: 32px clamp(16px, 4vw, 48px) 80px;
            scroll-behavior: smooth;
            scroll-padding: 20px;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
            transition: background 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }

        .message {
            max-width: 800px;
            margin: 0 auto 32px auto;
            padding: 20px 0;
            animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            animation-fill-mode: forwards;
        }

        .message:nth-child(even) {
            animation-delay: 0.05s;
        }

        .message:nth-child(odd) {
            animation-delay: 0.1s;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1) 0.2s;
            opacity: 0;
            animation-fill-mode: forwards;
            position: relative;
        }

        .message-delete-btn {
            margin-left: auto;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            opacity: 0;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .message:hover .message-delete-btn {
            opacity: 1;
        }

        .message-delete-btn:hover {
            background: var(--bg-tertiary);
            color: var(--error-color, #ef4444);
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) 0.3s;
            opacity: 0;
            animation-fill-mode: forwards;
        }

        .message-avatar.user {
            background: var(--accent-color);
            color: white;
        }

        .message-avatar.user:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .message-avatar.assistant {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .message-avatar.assistant:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .message-sender {
            font-weight: 600;
            font-size: 14px;
        }

        .message-content {
            margin-left: 44px;
            line-height: 1.7;
            font-size: 15px;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) 0.3s;
            opacity: 0;
            animation-fill-mode: forwards;
        }

        .message-content p {
            margin-bottom: 12px;
        }

        .message-content h1,
        .message-content h2,
        .message-content h3 {
            margin-top: 16px;
            margin-bottom: 8px;
        }

        .message-content ul,
        .message-content ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .message-content li {
            margin-bottom: 4px;
        }

        .message-content code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .message-content pre {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
            margin: 12px 0;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .code-block-wrapper {
            position: relative;
            margin: 12px 0;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px 8px 0 0;
            border: 1px solid var(--border-color);
            border-bottom: none;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .code-actions {
            display: flex;
            gap: 8px;
        }

        .code-btn {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .code-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }

        .code-btn:hover {
            background: var(--hover-bg);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .code-btn:hover::before {
            width: 150px;
            height: 150px;
        }

        .code-btn:active {
            transform: translateY(0);
        }

        /* Skeleton Loading Animation */
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--bg-tertiary) 0%,
                var(--hover-bg) 50%,
                var(--bg-tertiary) 100%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
            border-radius: 4px;
        }

        .skeleton-text {
            height: 1em;
            margin-bottom: 0.5em;
        }

        .skeleton-title {
            height: 1.5em;
            width: 60%;
            margin-bottom: 1em;
        }

        .skeleton-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .skeleton-button {
            height: 36px;
            width: 100px;
            border-radius: 8px;
        }

        /* Loading Spinner */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .loading-spinner-small {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Progress Bar Animation */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(
                90deg,
                var(--accent-color),
                var(--accent-color),
                transparent
            );
            background-size: 200% 100%;
            animation: shimmer 2s ease-in-out infinite;
            border-radius: 2px;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .html-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            backdrop-filter: blur(4px);
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .html-preview-modal.show {
            display: flex;
            opacity: 1;
            animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .html-preview-container {
            width: 90%;
            height: 90%;
            background: var(--bg-primary);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: scaleIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .html-preview-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .html-preview-title {
            font-size: 16px;
            font-weight: 600;
        }

        .html-preview-close {
            padding: 8px 16px;
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .html-preview-close:hover {
            background: var(--hover-bg);
            transform: rotate(90deg) scale(1.1);
            border-color: var(--accent-color);
        }

        .html-preview-close:active {
            transform: rotate(90deg) scale(0.95);
        }

        .html-preview-close:hover {
            background: var(--hover-bg);
        }

        .html-preview-iframe {
            flex: 1;
            border: none;
            background: white;
            width: 100%;
            height: 100%;
        }

        /* ARTIFACT / LIVE CODE EDITOR SYSTEM (Claude Style) */
        .artifact-container {
            margin: 20px 0;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            background: var(--bg-secondary);
            animation: fadeIn 0.3s ease;
        }

        .artifact-header {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .artifact-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .artifact-actions {
            display: flex;
            gap: 8px;
        }

        .artifact-btn {
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .artifact-btn:hover {
            background: var(--hover-bg);
        }

        .artifact-content {
            display: flex;
            height: 600px;
            max-height: 80vh;
        }

        .artifact-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
        }

        .artifact-editor-header {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .artifact-editor-content {
            flex: 1;
            overflow: auto;
            background: var(--code-bg);
        }

        .artifact-editor textarea {
            width: 100%;
            height: 100%;
            padding: 16px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            outline: none;
            tab-size: 2;
            -moz-tab-size: 2;
        }

        .artifact-editor textarea::selection {
            background: rgba(102, 126, 234, 0.3);
        }

        .artifact-preview {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .artifact-preview-header {
            padding: 8px 12px;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            font-size: 12px;
            font-weight: 500;
            color: #666;
        }

        .artifact-preview-iframe {
            flex: 1;
            border: none;
            width: 100%;
            height: 100%;
            background: white;
        }

        .artifact-splitter {
            width: 4px;
            background: var(--border-color);
            cursor: col-resize;
            transition: background 0.2s;
        }

        .artifact-splitter:hover {
            background: var(--accent-color);
        }

        /* PRESENTATION MODE */
        .presentation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 3000;
            display: none;
            flex-direction: column;
        }

        .presentation-container.active {
            display: flex;
        }

        .presentation-header {
            padding: 16px 24px;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .presentation-title {
            color: white;
            font-size: 16px;
            font-weight: 600;
        }

        .presentation-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .presentation-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .presentation-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .presentation-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            padding: 40px;
        }

        .presentation-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .typing-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .typing-star {
            width: 20px;
            height: 20px;
            display: inline-block;
            position: relative;
        }

        .typing-star::before {
            content: '‚ú¶';
            font-size: 20px;
            color: transparent;
            background: var(--typing-star-color);
            -webkit-background-clip: text;
            background-clip: text;
            display: block;
            animation: starPulse 1.5s ease-in-out infinite;
        }

        @keyframes starPulse {
            0%, 100% {
                opacity: 0.3;
                transform: scale(0.8) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.2) rotate(180deg);
            }
        }

        /* Legacy typing dots (fallback) */
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            animation: pulse 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        /* Live Coding Animation */
        .live-coding-box {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.5;
            position: relative;
            overflow: hidden;
            max-width: 100%;
        }

        .live-coding-content {
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
        }

        .live-coding-cursor {
            display: inline-block;
            width: 2px;
            height: 1.1em;
            background: linear-gradient(120deg, #a855f7, #4ade80);
            margin-left: 1px;
            animation: blinkCursor 0.8s step-end infinite;
            vertical-align: text-bottom;
            opacity: 0.9;
        }

        @keyframes blinkCursor {
            0%, 50% {
                opacity: 0.9;
            }
            51%, 100% {
                opacity: 0.2;
            }
        }

        .assistant-typing {
            font-size: 15px;
            line-height: 1.7;
            white-space: pre-wrap;
            color: var(--text-primary);
            letter-spacing: 0.01em;
            animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .assistant-typing::after {
            content: '';
            display: inline-block;
            width: 2px;
            height: 1em;
            background: linear-gradient(120deg, #a855f7, #4ade80);
            margin-left: 2px;
            animation: blinkCursor 0.8s step-end infinite;
            vertical-align: baseline;
        }

        .live-coding-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
            font-size: 11px;
            color: var(--text-secondary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            opacity: 0.7;
        }

        .live-coding-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-color);
            opacity: 0.8;
        }

        .chat-input-wrapper {
            padding: 20px 24px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chat-input-container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 16px;
            background: var(--surface-muted);
            box-shadow: var(--shadow);
        }

        .chat-input-wrapper.collapsed {
            padding: 8px 16px;
            max-height: 56px;
            overflow: hidden;
            opacity: 0.85;
        }

        .chat-input-wrapper.collapsed::after {
            content: 'Chatleiste ausgeblendet';
            display: block;
            text-align: center;
            font-size: 13px;
            color: var(--text-secondary);
            letter-spacing: 0.02em;
        }

        .chat-input-wrapper.collapsed .chat-input-container {
            opacity: 0;
            pointer-events: none;
        }

        .mobile-input-toggle {
            display: none;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: none;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            align-items: center;
            justify-content: center;
        }

        .mobile-input-toggle:hover {
            background: var(--hover-bg);
        }

        .mobile-input-toggle.active {
            background: var(--accent-color);
            color: #fff;
            border-color: transparent;
        }

        .model-selector-container {
            margin-bottom: 12px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .model-selector {
            position: relative;
        }

        .model-selector-btn {
            padding: 8px 16px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .model-selector-btn:hover {
            background: var(--hover-bg);
        }

        .model-dropdown {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            margin-bottom: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px;
            min-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 10px 40px var(--shadow);
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }

        .model-dropdown.show {
            display: block;
        }

        .model-category {
            margin-bottom: 12px;
        }

        .model-category-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 8px 12px;
            text-transform: uppercase;
        }

        .model-option {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 2px;
        }

        .model-option:hover {
            background: var(--hover-bg);
        }

        .model-option.active {
            background: var(--accent-color);
            color: white;
        }

        .model-option-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .model-option-desc {
            font-size: 12px;
            opacity: 0.7;
        }

        /* ? Adjusted: input-field Styles */
        .input-field {
            width: 100%; /* Ensure full width */
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .input-field:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.5);
            background: rgba(255, 255, 255, 0.06);
            box-shadow: 
                0 0 0 3px rgba(102, 126, 234, 0.1),
                0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        .input-field:hover {
            border-color: rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.05);
        }

        /* Rest of the styles unchanged... */
        .input-box {
            position: relative;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 12px 20px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .input-box:focus-within {
            border-color: var(--accent-color);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .chat-textarea {
            width: 100%;
            background: none;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            resize: none;
            max-height: 200px;
            padding-right: 160px;
            line-height: 1.5;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chat-textarea:focus {
            transform: scale(1.01);
        }

        .chat-textarea::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chat-textarea:focus::placeholder {
            opacity: 0.3;
        }

        .input-actions {
            position: absolute;
            right: 12px;
            bottom: 12px;
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .input-action-btn {
            padding: 8px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-action-btn:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        .input-action-btn.recording {
            color: #ef4444;
            animation: pulse 1s infinite;
        }

        .send-btn {
            padding: 10px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: 200% 200%;
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .send-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
            background-position: 100% 50%;
            animation: gradientShift 3s ease infinite;
        }

        .send-btn:hover:not(:disabled)::before {
            width: 300px;
            height: 300px;
        }

        .send-btn:active:not(:disabled) {
            transform: translateY(-1px) scale(1.02);
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            animation: pulseSoft 2s ease-in-out infinite;
        }

        .file-preview {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .file-preview-item {
            position: relative;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .file-preview-remove {
            padding: 2px 6px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .file-preview-remove:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
            animation: fadeIn 0.5s ease;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 40px;
        }

        .suggestion-chips {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            max-width: 800px;
            width: 100%;
        }

        .suggestion-chip {
            padding: 16px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .suggestion-chip:hover {
            background: var(--hover-bg);
            transform: translateY(-2px);
        }

        .suggestion-icon {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .suggestion-text {
            font-size: 14px;
            font-weight: 500;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .sidebar-overlay.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .mobile-menu-btn {
            display: none;
            padding: 8px 12px;
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mobile-menu-btn:hover {
            background: var(--hover-bg);
        }

        .login-container {
            min-height: 100vh;
            padding: 40px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(9, 11, 32, 0.95), rgba(15, 23, 42, 0.92)),
                        url('https://images.unsplash.com/photo-1523580846011-d3a5bc25702b?auto=format&fit=crop&w=1600&q=80') center/cover fixed;
            animation: fadeIn 0.5s ease;
        }

        .auth-hero {
            width: 100%;
            max-width: 1180px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 32px;
        }

        .auth-info {
            background: rgba(15, 23, 42, 0.85);
            border-radius: 24px;
            padding: 40px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.45);
            color: #f8fafc;
            backdrop-filter: blur(8px);
        }

        .auth-logo {
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 14px;
            color: #94a3b8;
        }

        .auth-info h1 {
            font-size: 34px;
            margin: 18px 0 10px;
            color: #fff;
        }

        .auth-info p {
            color: #cbd5f5;
            line-height: 1.6;
        }

        .feature-list {
            list-style: none;
            margin: 28px 0 0;
            padding: 0;
            display: grid;
            gap: 12px;
        }

        .feature-list li {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            color: #e2e8f0;
        }

        .feature-list i {
            color: #38bdf8;
        }

        .trust-badges {
            margin-top: 28px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .trust-badge {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #cbd5f5;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auth-card {
            background: var(--bg-secondary);
            border-radius: 24px;
            padding: 32px;
            border: 1px solid var(--border-color);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.35);
        }

        .auth-tabs {
            display: flex;
            background: var(--bg-primary);
            border-radius: 14px;
            padding: 4px;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .auth-tab.active {
            background: var(--accent-color);
            color: #fff;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .login-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 18px;
        }

        .auth-form.hidden {
            display: none;
        }

        .main-nav-tabs {
            display: flex;
            gap: 12px;
            padding: 24px 32px 0;
        }

        .switch-tab {
            flex: none;
            padding: 10px 22px;
            border-radius: 999px;
            border: 1px solid var(--glass-border);
            background: transparent;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            letter-spacing: 0.01em;
            backdrop-filter: blur(12px);
            transition: all 0.2s ease;
        }

        .switch-tab.active {
            background: var(--surface-muted);
            color: var(--text-primary);
            border-color: transparent;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .home-view {
            padding: 24px 32px 32px;
            display: flex;
            flex-direction: column;
            gap: 32px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }
        .chat-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .home-hero {
            border-radius: 32px;
            padding: 48px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: 
                linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%),
                radial-gradient(circle at 20% 30%, rgba(102, 126, 234, 0.1), transparent 50%);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.05) inset;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(24px) saturate(180%);
            animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .home-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(102, 126, 234, 0.5), 
                rgba(168, 85, 247, 0.5), 
                transparent);
        }

        .home-hero::after {
            content: '';
            position: absolute;
            inset: 0;
            background: 
                radial-gradient(circle at 10% 20%, rgba(168, 85, 247, 0.15), transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(102, 126, 234, 0.1), transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(74, 222, 128, 0.05), transparent 50%);
            pointer-events: none;
            animation: float 20s ease-in-out infinite;
        }

        .hero-left {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: fit-content;
            overflow: visible;
        }

        .hero-eyebrow {
            font-size: 13px;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .hero-left h2 {
            font-size: clamp(28px, 4vw, 42px);
            margin: 0;
            line-height: 1.2;
        }

        .hero-left p {
            color: var(--text-secondary);
            font-size: 15px;
            max-width: 420px;
        }

        .hero-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .hero-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .hero-pill {
            padding: 6px 14px;
            border-radius: 999px;
            background: var(--surface-muted);
            border: 1px solid var(--glass-border);
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .pill-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: linear-gradient(120deg, #a855f7, #4ade80);
            display: inline-block;
        }

        .hero-right {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            min-height: fit-content;
            overflow: visible;
        }
        
        .home-hero {
            display: flex;
            gap: 32px;
            align-items: flex-start;
            min-height: fit-content;
            overflow: visible;
        }

        .hero-stat-card {
            padding: 24px;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.05) inset;
            backdrop-filter: blur(20px) saturate(180%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) backwards;
        }

        .hero-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(102, 126, 234, 0.4), 
                transparent);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .hero-stat-card:hover {
            transform: translateY(-4px);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 
                0 8px 24px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            background: rgba(255, 255, 255, 0.05);
        }

        .hero-stat-card:hover::before {
            opacity: 1;
        }

        .hero-stat-card p {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .hero-stat-card h3 {
            font-size: 32px;
            margin: 0;
        }

        .hero-stat-card span {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .home-panels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 28px;
        }

        .card-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.05) inset,
                0 1px 0 rgba(255, 255, 255, 0.1) inset;
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(24px) saturate(180%);
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(102, 126, 234, 0.5), 
                rgba(168, 85, 247, 0.5), 
                transparent);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .card-panel:hover {
            transform: translateY(-4px);
            box-shadow: 
                0 12px 48px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset,
                0 1px 0 rgba(255, 255, 255, 0.15) inset;
            border-color: rgba(255, 255, 255, 0.15);
        }

        .card-panel:hover::before {
            opacity: 1;
        }

        .panel-header h3 {
            margin-bottom: 6px;
            font-size: 20px;
        }

        .panel-header p {
            color: var(--text-secondary);
            font-size: 14px;
            max-width: 420px;
        }

        .panel-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .curriculum-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-end;
        }

        .curriculum-select-group {
            flex: 1 1 180px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .curriculum-select-group label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .curriculum-select {
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-primary);
            padding: 10px 12px;
            width: 100%;
        }

        .curriculum-refresh-btn {
            align-self: flex-end;
            padding: 10px 16px;
            border-radius: 12px;
            border: 1px solid transparent;
            background: var(--accent-color);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .curriculum-refresh-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .curriculum-meta {
            border: 1px dashed var(--border-color);
            border-radius: 16px;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: rgba(255, 255, 255, 0.02);
            font-size: 13px;
            color: var(--text-secondary);
        }

        .curriculum-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .curriculum-subject {
            border: 1px solid var(--border-color);
            border-radius: 18px;
            padding: 18px;
            background: var(--bg-primary);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.2);
        }

        .curriculum-subject-header {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .curriculum-focus {
            margin-top: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .curriculum-chip {
            background: rgba(102, 126, 234, 0.15);
            color: var(--accent-color);
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
        }

        .curriculum-topic-count {
            font-size: 12px;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.06);
            border-radius: 999px;
            padding: 4px 10px;
            align-self: flex-start;
        }

        .curriculum-topic-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .curriculum-topic-card {
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 14px;
            background: var(--bg-secondary);
        }

        .curriculum-topic-title {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 16px;
        }

        .curriculum-competencies,
        .curriculum-resources {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .curriculum-competency {
            border: 1px solid var(--border-color);
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.04);
        }

        .curriculum-resource {
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 6px 10px;
            text-decoration: none;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.02);
            transition: border 0.2s ease, transform 0.2s ease;
        }

        .curriculum-resource:hover {
            border-color: var(--accent-color);
            transform: translateY(-1px);
        }

        .curriculum-resource-type {
            font-size: 12px;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .curriculum-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px;
            border: 1px dashed var(--border-color);
            border-radius: 16px;
            color: var(--text-secondary);
        }

        .curriculum-error {
            color: #ff8a8a;
        }

        .homework-list {
            display: grid;
            gap: 14px;
        }

        .homework-card {
            padding: 16px;
            border-radius: 18px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.01);
            backdrop-filter: blur(10px);
            animation: fadeIn 0.4s ease;
        }

        .homework-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .homework-card h4 {
            margin-bottom: 4px;
            font-size: 18px;
        }

        .homework-card p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .card-action-btn,
        .icon-button {
            border: 1px solid var(--glass-border);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 50%;
            width: 34px;
            height: 34px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .card-action-btn:hover,
        .icon-button:hover {
            color: var(--text-primary);
            border-color: var(--text-primary);
            transform: translateY(-1px);
        }

        .material-card {
            position: relative;
        }

        .material-card .card-action-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 2;
        }

        .homework-card h4 {
            margin-bottom: 6px;
        }

        .homework-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        .materials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .material-card {
            border-radius: 18px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            padding: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .material-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-color);
        }

        .material-thumb {
            border-radius: 12px;
            background: var(--bg-secondary);
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .material-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .material-thumb i {
            font-size: 32px;
            color: var(--text-secondary);
        }

        .material-info h4 {
            font-size: 15px;
            line-height: 1.3;
        }

        .material-info span {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .materials-upload {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .materials-upload textarea {
            grid-column: 1 / -1;
            min-height: 80px;
        }

        .materials-upload input[type="file"] {
            display: none;
        }

        .upload-label {
            border: 1px dashed var(--glass-border);
            border-radius: 12px;
            padding: 10px 12px;
            text-align: center;
            cursor: pointer;
            color: var(--text-secondary);
            background: var(--surface-muted);
            transition: border-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
        }

        .upload-label:hover {
            border-color: var(--text-primary);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        .empty-state {
            padding: 20px;
            text-align: center;
            border: 1px dashed var(--border-color);
            border-radius: 16px;
            color: var(--text-secondary);
        }

        .material-modal-content img {
            width: 100%;
            border-radius: 16px;
            margin-bottom: 16px;
        }

        .material-modal-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .uploader-meta {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .profile-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            overflow: hidden;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .dashboard-watermark {
            position: absolute;
            right: 20px;
            bottom: 20px;
            font-size: 12px;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.15);
        }

        .avatar-preview {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 2px dashed var(--border-color);
            overflow: hidden;
            margin-bottom: 8px;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .home-view.hidden,
        .chat-view.hidden {
            display: none;
        }

        .auth-note {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 10px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .input-field {
            /* Adjusted: input-field Styles */
            width: 100%; /* Ensure full width */
            padding: 12px 16px;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            color: var(--text-primary);
            backdrop-filter: blur(10px);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--text-primary);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: inline-flex;
            gap: 8px;
            align-items: center;
        }

        .btn:hover {
            background: var(--surface-muted);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: 200% 200%;
            color: #ffffff !important;
            border-color: transparent;
            box-shadow: 
                0 4px 15px rgba(102, 126, 234, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            position: relative;
            overflow: hidden;
            animation: gradientShift 3s ease infinite;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 
                0 8px 25px rgba(102, 126, 234, 0.6),
                0 0 0 1px rgba(255, 255, 255, 0.15) inset;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-ghost {
            border-color: transparent;
            color: var(--text-secondary);
            background: transparent;
        }

        .btn-ghost:hover {
            color: var(--text-primary);
            border-color: var(--glass-border);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.4);
            color: #f87171;
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.12);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.25);
        }

        .alert-success {
            background: rgba(16, 163, 127, 0.12);
            color: #10a37f;
            border: 1px solid rgba(16, 163, 127, 0.25);
        }

        .hidden {
            display: none !important;
        }

        /* Custom scrollbar styles, unchanged... */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Loader */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @media (max-width: 768px) {
            /* Fix mobile viewport and initial render */
            html, body {
                width: 100%;
                height: 100%;
                height: 100dvh; /* Dynamic viewport height */
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
            }
            
            .app-container {
                min-height: 100vh;
                min-height: 100dvh;
                padding: 0;
                gap: 0;
            }
            
            .auth-hero {
                grid-template-columns: 1fr;
                min-height: 100vh;
                min-height: 100dvh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            .auth-info, .auth-card {
                padding: 24px;
            }
            .login-container {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                height: 100vh;
                height: 100dvh;
            }

            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                height: 100dvh;
                z-index: 1001;
                width: 280px;
            }

            .sidebar.collapsed {
                transform: translateX(-100%);
            }
            
            .main-content {
                width: 100%;
                min-height: 100vh;
                min-height: 100dvh;
            }

            .mobile-menu-btn {
                display: flex;
            }

            .chat-header {
                padding: 0 16px;
            }

            .chat-messages {
                padding: 16px;
            }

            .header-actions {
                flex-wrap: wrap;
                justify-content: flex-end;
            }

            .mobile-input-toggle {
                display: flex;
            }

            .chat-input-container {
                max-width: 100%;
            }

            .chat-input-wrapper {
                padding: 16px;
            }

            .message {
                max-width: 100%;
                margin: 0 auto 20px auto;
            }

            .input-box {
                border-radius: 20px;
                padding: 10px 16px;
            }

            .chat-textarea {
                font-size: 16px; /* Prevents zoom on iOS */
            }

            /* Artifact Mobile Styles */
            .artifact-container {
                margin: 16px 0;
            }

            .artifact-content {
                flex-direction: column;
                height: auto;
                max-height: none;
            }

            .artifact-editor {
                flex: 1;
                min-height: 300px;
                max-height: 400px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .artifact-preview {
                flex: 1;
                min-height: 300px;
                max-height: 400px;
            }

            .artifact-splitter {
                display: none; /* Hide splitter on mobile */
            }

            .artifact-header {
                flex-wrap: wrap;
                gap: 8px;
            }

            .artifact-actions {
                flex-wrap: wrap;
                gap: 6px;
            }

            .artifact-btn {
                font-size: 11px;
                padding: 5px 10px;
            }

            /* Modal Mobile Styles */
            .modal-content {
                max-width: 95vw;
                max-height: 95vh;
                margin: 10px;
            }

            .modal-body {
                padding: 16px;
            }

            .modal-header {
                padding: 16px;
            }

            /* Input improvements for mobile */
            .model-selector-container {
                margin-bottom: 8px;
            }

            .input-actions {
                right: 8px;
                gap: 4px;
            }

            .input-action-btn {
                padding: 6px;
                font-size: 14px;
            }

            .chat-textarea {
                padding-right: 140px;
            }

            .send-btn {
                padding: 8px 14px;
            }

            .welcome-screen {
                padding: 20px;
            }

            .welcome-title {
                font-size: 24px;
            }

            .suggestion-chips {
                grid-template-columns: 1fr;
            }

            .header-btn span {
                display: none;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
            opacity: 0;
            backdrop-filter: blur(4px);
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal.show {
            display: flex;
            opacity: 1;
            animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-content {
            background: rgba(12, 12, 18, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px;
            max-width: 600px;
            max-height: 90vh;
            width: 100%;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(255, 255, 255, 0.05) inset;
            padding: 0;
            overflow: hidden;
            animation: scaleIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            transform-origin: center center;
            backdrop-filter: blur(32px) saturate(180%);
            position: relative;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(102, 126, 234, 0.5), 
                rgba(168, 85, 247, 0.5), 
                transparent);
        }
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-modal:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
            transform: rotate(90deg) scale(1.1);
        }

        .close-modal:active {
            transform: rotate(90deg) scale(0.95);
        }
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }
        .settings-section {
            margin-bottom: 32px;
        }
        .settings-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        .setting-item {
            margin-bottom: 24px;
        }
        .setting-label {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        .setting-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .toggle-switch {
            width: 40px;
            height: 22px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
            display: inline-block;
            vertical-align: middle;
        }
        .toggle-switch::before {
            content: '';
            position: absolute;
            left: 3px;
            top: 3px;
            width: 16px;
            height: 16px;
            background: var(--text-secondary);
            border-radius: 50%;
            transition: left 0.2s, background 0.2s;
        }
        .toggle-switch.active {
            background: var(--accent-color);
        }
        .toggle-switch.active::before {
            left: 21px;
            background: #fff;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- LOGIN PAGE -->
    <div id="loginPage" class="login-container">
        <div class="auth-hero">
            <div class="auth-info">
                <div class="auth-logo">Aeon AI ‚Ä¢ Classroom</div>
                <h1>Alles f√ºr deine Schule an einem Ort</h1>
                <p>Hausaufgaben teilen, Lernmaterial sammeln und den WhatsApp-Bot steuern ‚Äì ganz ohne Technik-Sprache.</p>
                <ul class="feature-list">
                    <li><i class="fas fa-shield-alt"></i> Sicherer Login f√ºr deine Klasse</li>
                    <li><i class="fas fa-rocket"></i> Aufgaben, Bilder und Erkl√§rungen in Sekunden</li>
                    <li><i class="fas fa-users-cog"></i> √úbersichtliches Sch√ºler-Panel</li>
                </ul>
                <div class="trust-badges">
                    <div class="trust-badge"><i class="fas fa-lock"></i> Deine Daten bleiben bei uns</div>
                    <div class="trust-badge"><i class="fas fa-graduation-cap"></i> F√ºr echte Schulthemen gemacht</div>
                    <div class="trust-badge"><i class="fas fa-bolt"></i> Funktioniert auch auf dem Handy</div>
                </div>
            </div>
            <div class="auth-card">
                <div class="auth-tabs">
                    <button type="button" class="auth-tab active" data-target="login">Anmelden</button>
                    <button type="button" class="auth-tab" data-target="register">Registrieren</button>
                </div>

                <div class="auth-form" id="loginFormWrapper">
                    <h2 class="login-title">Willkommen zur√ºck</h2>
                    <div id="loginError" class="alert alert-error hidden"></div>
                    <form id="loginForm">
                        <div class="form-group">
                            <label class="form-label">Benutzername</label>
                            <input type="text" id="username" class="input-field" required autocomplete="username" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Passwort</label>
                            <input type="password" id="password" class="input-field" required autocomplete="current-password" />
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Anmelden</button>
                    </form>
                    <div class="auth-note">Sch√ºler, bitte melde dich an oder frag den Admin.</div>
                </div>

                <div class="auth-form hidden" id="registerFormWrapper">
                    <h2 class="login-title">Kostenlos registrieren</h2>
                    <div id="registerError" class="alert alert-error hidden"></div>
                    <div id="registerSuccess" class="alert alert-success hidden"></div>
                    <form id="registerForm">
                        <div class="form-group">
                            <label class="form-label">Benutzername</label>
                            <input type="text" id="registerUsername" class="input-field" required autocomplete="off" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telefonnummer (optional)</label>
                            <input type="text" id="registerPhone" class="input-field" placeholder="+49..." autocomplete="tel" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Passwort (min. 6 Zeichen)</label>
                            <input type="password" id="registerPassword" class="input-field" required minlength="6" autocomplete="new-password" />
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Registrierung starten</button>
                    </form>
                    <div class="auth-note">Nach der Registrierung siehst du sofort dein Dashboard. Wenn du Fragen hast, melde dich einfach bei deinem Team.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboardPage" class="app-container hidden">
        <!-- Sidebar Overlay (Mobile) -->
        <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- SIDEBAR -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="createNewChat()">
                    <i class="fas fa-plus"></i>
                    <span>Neuer Chat</span>
                </button>
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <div class="chat-list" id="chatList">
                <!-- Chat items will be injected here -->
            </div>

            <div class="sidebar-footer">
                <div class="user-menu" onclick="toggleUserMenu()">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Admin</div>
                        <div class="user-role" id="userRole">Administrator</div>
                    </div>
                    <i class="fas fa-ellipsis-h"></i>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <div class="main-nav-tabs">
                <button class="switch-tab active" data-main-view="home">
                    <i class="fas fa-book-open"></i> Hausaufgaben
                </button>
                <button class="switch-tab" data-main-view="chat">
                    <i class="fas fa-robot"></i> KI Chat
                </button>
            </div>

            <!-- Admin-Nachricht Banner -->
            <div id="adminBanner" style="display: none; margin-bottom: 20px; padding: 16px 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(168, 85, 247, 0.15)); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 12px; backdrop-filter: blur(10px);">
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <i class="fas fa-bullhorn" style="color: var(--accent-color);"></i>
                            <strong style="color: var(--text-primary);">Admin-Nachricht</strong>
                        </div>
                        <div id="adminBannerMessage" style="color: var(--text-primary); line-height: 1.5;"></div>
                    </div>
                    <button onclick="document.getElementById('adminBanner').style.display='none'" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px 8px; border-radius: 4px; opacity: 0.7; transition: all 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <section id="homeView" class="home-view">
                <div class="home-hero animate-fade-in">
                    <div class="hero-left">
                        <p class="hero-eyebrow">Heute</p>
                        <h2>Alles Wichtige f√ºr deine Klasse</h2>
                        <p>Checke offene Aufgaben, lade Material hoch oder hol dir in Sekunden Hilfe vom Schul-Assistenten.</p>
                        <div class="hero-actions">
                            <button class="btn btn-primary" onclick="switchMainView('chat')">
                                <i class="fas fa-bolt"></i>
                                AI fragen
                            </button>
                            <button class="btn btn-ghost" onclick="focusHomeworkInput()">
                                <i class="fas fa-pen"></i>
                                Aufgabe eintragen
                            </button>
                        </div>
                        <div class="hero-pills">
                            <span class="hero-pill"><span class="pill-dot"></span> Status: aktiv</span>
                            <span class="hero-pill">Rheinland-Pfalz ‚Ä¢ Gymnasium</span>
                        </div>
                    </div>
                    <div class="hero-right">
                        <div class="hero-stat-card">
                            <p>Offene Aufgaben</p>
                            <h3 id="heroHomeworkCount">0</h3>
                            <span>aktuell gemeldet</span>
                        </div>
                        <div class="hero-stat-card">
                            <p>Materialien</p>
                            <h3 id="heroMaterialCount">0</h3>
                            <span>geteilt mit der Klasse</span>
                        </div>
                    </div>
                </div>
                <div class="home-panels">
                    <div class="card-panel">
                        <div class="panel-header">
                            <h3>Hausaufgaben</h3>
                            <p>Trage kurz ein, was noch zu erledigen ist. Alle sehen sofort den Stand.</p>
                        </div>
                        <form id="homeworkForm" class="panel-form">
                            <input type="text" id="homeworkSubject" class="input-field" placeholder="Fach z.B. Mathematik" required />
                            <textarea id="homeworkDescription" class="input-field" placeholder="Beschreibe kurz die Aufgabe" required></textarea>
                            <button type="submit" class="btn btn-primary">Hausaufgabe speichern</button>
                        </form>
                        <div id="homeworkList" class="homework-list">
                            <div class="empty-state">Noch keine Hausaufgaben vorhanden. F√ºge jetzt deine Aufgabe hinzu!</div>
                        </div>
                    </div>
                    <div class="card-panel">
                        <div class="panel-header">
                            <h3>Material & Tipps</h3>
                            <p>Lade Zusammenfassungen, Bilder oder Links hoch, damit alle schneller fertig werden.</p>
                        </div>
                        <form id="materialForm" class="panel-form" enctype="multipart/form-data">
                            <div class="materials-upload">
                                <input type="text" id="materialTitle" class="input-field" placeholder="Titel z.B. Analysis Zusammenfassung" required />
                                <input type="text" id="materialSubject" class="input-field" placeholder="Fach" />
                                <textarea id="materialDescription" class="input-field" placeholder="Kurzbeschreibung"></textarea>
                                <label class="upload-label">
                                    <i class="fas fa-cloud-upload-alt"></i> Datei w√§hlen (optional)
                                    <input type="file" id="materialFile" accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg,.ppt,.pptx" onchange="handleMaterialFileSelect(event)" />
                                </label>
                                <div id="materialFilePreview" style="display: none; margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <i class="fas fa-file" style="font-size: 24px; color: var(--accent-color);"></i>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 500; margin-bottom: 4px;" id="materialPreviewName"></div>
                                            <div style="font-size: 12px; color: var(--text-secondary);" id="materialPreviewSize"></div>
                                        </div>
                                        <button type="button" class="btn" onclick="clearMaterialFile()" style="padding: 6px 12px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Material hochladen</button>
                        </form>
                        <div id="materialsGrid" class="materials-grid">
                            <div class="empty-state">Noch kein Material hochgeladen.</div>
                        </div>
                    </div>
                    <div class="card-panel">
                        <div class="panel-header">
                            <h3>Chat f√ºr alle</h3>
                            <p>Kommuniziere mit allen Benutzern in einem gemeinsamen Chat.</p>
                        </div>
                        <div id="publicChatContainer" style="max-height: 400px; overflow-y: auto; padding: 16px; background: var(--bg-secondary); border-radius: 12px; margin-top: 16px;">
                            <div id="publicChatMessages" style="display: flex; flex-direction: column; gap: 12px;">
                                <div class="empty-state">Noch keine Nachrichten. Starte die Unterhaltung!</div>
                            </div>
                            <div id="publicChatFilePreview" style="margin-top: 12px; display: none;"></div>
                            <div style="margin-top: 16px; display: flex; gap: 8px; align-items: flex-end;">
                                <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                                    <input type="text" id="publicChatInput" class="input-field" placeholder="Nachricht schreiben..." />
                                    <input type="file" id="publicChatFileInput" multiple accept="image/*,.pdf,.doc,.docx,.txt" style="display: none;" onchange="handlePublicChatFileSelect(event)" />
                                </div>
                                <button class="btn" onclick="document.getElementById('publicChatFileInput').click()" title="Datei anh√§ngen">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <button class="btn btn-primary" onclick="sendPublicMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-panel">
                        <div class="panel-header">
                            <h3>Webuntis</h3>
                            <p>Melde dich mit deinen Webuntis-Zugangsdaten an, um deinen Stundenplan zu sehen.</p>
                        </div>
                        <div id="webuntisStatus" style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div id="webuntisNotConnected" style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-unlink" style="color: var(--text-secondary);"></i>
                                <span style="color: var(--text-secondary);">Nicht verbunden</span>
                            </div>
                            <div id="webuntisConnected" style="display: none; flex-direction: column; gap: 8px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <i class="fas fa-check-circle" style="color: #4ade80;"></i>
                                    <span style="color: var(--text-primary);">Verbunden als: <strong id="webuntisUsernameDisplay"></strong></span>
                                </div>
                                <button class="btn" onclick="disconnectWebuntis()" style="margin-top: 8px; width: fit-content;">
                                    <i class="fas fa-sign-out-alt"></i> Trennen
                                </button>
                            </div>
                        </div>
                        <form id="webuntisForm" class="panel-form" style="display: none;">
                            <input type="text" id="webuntisServer" class="input-field" placeholder="Server (z.B. hepta.webuntis.com)" required />
                            <input type="text" id="webuntisSchool" class="input-field" placeholder="Schule" required />
                            <input type="text" id="webuntisUsernameInput" class="input-field" placeholder="Benutzername" required />
                            <input type="password" id="webuntisPassword" class="input-field" placeholder="Passwort" required />
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plug"></i> Mit Webuntis verbinden
                            </button>
                        </form>
                        <button id="webuntisConnectBtn" class="btn btn-primary" onclick="showWebuntisForm()">
                            <i class="fas fa-plug"></i> Webuntis verbinden
                        </button>
                    </div>
                </div>
            </section>

            <section id="chatView" class="chat-view hidden">
                <div class="chat-header">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="chat-title" id="chatTitle">Aeon AI</div>
                    <div class="header-actions">
                        <button class="header-btn" id="sidebarPinToggle" onclick="toggleSidebarPinned()" title="Chats ein-/ausblenden" aria-pressed="false">
                            <i class="fas fa-columns"></i>
                        </button>
                        <button class="mobile-input-toggle" id="mobileInputToggle" onclick="toggleChatInputVisibility()" title="Chatleiste ein-/ausblenden">
                            <i class="fas fa-keyboard"></i>
                        </button>
                        <button class="grid-view-toggle" id="gridViewBtn" onclick="toggleGridView()">
                            <i class="fas fa-th"></i>
                            <span>Grid</span>
                        </button>
                        <button class="header-btn" onclick="openImageGen()">
                            <i class="fas fa-image"></i>
                            <span>Bild</span>
                        </button>
                        <button class="header-btn" onclick="openSettings()">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </button>
                        <button class="theme-toggle" onclick="toggleTheme()">
                            <i id="themeIcon" class="fas fa-sun"></i>
                        </button>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <!-- Welcome screen or messages -->
                </div>

                <div class="chat-input-wrapper" id="chatInputWrapper">
                    <div class="chat-input-container">
                        <div class="file-preview" id="filePreview"></div>

                        <div class="model-selector-container">
                            <div class="model-selector">
                                <button class="model-selector-btn" onclick="toggleModelDropdown()">
                                    <i class="fas fa-brain"></i>
                                    <span id="selectedModelName">Auto</span>
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                                <div class="model-dropdown" id="modelDropdown">
                                    <!-- Model options will be injected here -->
                                </div>
                            </div>
                        </div>

                        <div class="input-box">
                            <textarea
                                class="chat-textarea"
                                id="chatInput"
                                placeholder="Nachricht an Aeon schreiben..."
                                rows="1"
                            ></textarea>
                            <div class="input-actions">
                                <input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx,.txt" style="display: none;" onchange="handleFileSelect(event)" />
                                <button class="input-action-btn" onclick="document.getElementById('fileInput').click()" title="Datei hochladen">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <button class="input-action-btn" onclick="openImageGen()" title="Bild generieren">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button class="input-action-btn" id="voiceBtn" onclick="toggleVoiceInput()" title="Sprachnachricht">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <div class="dashboard-watermark">Denn Studio</div>
        </main>
    </div>

    <!-- HTML PREVIEW MODAL -->
    <div id="htmlPreviewModal" class="html-preview-modal">
        <div class="html-preview-container">
            <div class="html-preview-header">
                <div class="html-preview-title">HTML Vorschau</div>
                <button class="html-preview-close" onclick="closeHtmlPreview()">
                    <i class="fas fa-times"></i> Schlie√üen
                </button>
            </div>
            <iframe id="htmlPreviewIframe" class="html-preview-iframe" sandbox="allow-scripts allow-same-origin"></iframe>
        </div>
    </div>

    <!-- PRESENTATION MODE -->
    <div id="presentationContainer" class="presentation-container">
        <div class="presentation-header">
            <div class="presentation-title" id="presentationTitle">Pr√§sentation</div>
            <div class="presentation-controls">
                <button class="presentation-btn" onclick="exitPresentation()">
                    <i class="fas fa-times"></i> Beenden
                </button>
            </div>
        </div>
        <div class="presentation-content">
            <iframe id="presentationIframe" class="presentation-iframe" sandbox="allow-scripts allow-same-origin"></iframe>
        </div>
    </div>

    <!-- ? NEW: Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Einstellungen</h2>
                <button class="close-modal" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body" id="settingsBody">
                <!-- Settings content will be injected here -->
            </div>
        </div>
    </div>

    <!-- ? NEW: Image Generation Modal -->
    <div id="imageGenModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">üé® Kostenlose Bildgenerierung (Pollinations.ai)</h2>
                <button class="close-modal" onclick="closeModal('imageGenModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="image-gen-container">
                    <div class="image-gen-form">
                        <textarea
                            id="imagePrompt"
                            class="image-gen-input"
                            placeholder="Beschreibe das Bild, das du generieren m√∂chtest...&#10;&#10;Beispiel: Ein futuristischer Roboter in einer Cyberpunk-Stadt bei Nacht, neonbeleuchtung, hochdetailliert"
                        ></textarea>

                        <div class="image-gen-options">
                            <div class="image-gen-option">
                                <label>Modell</label>
                                <select id="imageModel">
                                    <option value="flux">Flux (Standard - Beste Qualit√∂t)</option>
                                    <option value="flux-realism">Flux Realism (Fotorealistisch)</option>
                                    <option value="flux-anime">Flux Anime (Anime-Stil)</option>
                                    <option value="flux-3d">Flux 3D (3D-Stil)</option>
                                    <option value="turbo">Turbo (Sehr schnell)</option>
                                </select>
                            </div>
                            <div class="image-gen-option">
                                <label>Bildgr√∂√∂e</label>
                                <select id="imageSize">
                                    <option value="1024x1024">1024x1024 (Quadrat)</option>
                                    <option value="1024x768">1024x768 (Querformat)</option>
                                    <option value="768x1024">768x1024 (Hochformat)</option>
                                    <option value="1280x720">1280x720 (16:9 Widescreen)</option>
                                    <option value="720x1280">720x1280 (9:16 Vertical)</option>
                                    <option value="512x512">512x512 (Klein & Schnell)</option>
                                </select>
                            </div>
                        </div>

                        <button class="image-gen-button" id="generateImageBtn" onclick="generateImage()">
                            <i class="fas fa-magic"></i> Bild kostenlos generieren
                        </button>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px; text-align: center;">
                            ? Komplett kostenlos √∂ Kein API Key n√∂tig √∂ Unbegrenzte Nutzung
                        </p>
                    </div>

                    <div class="image-result" id="imageResult">
                        <img id="generatedImage" src="" alt="Generated Image" />
                        <div class="image-result-prompt">
                            <strong>Verwendeter Prompt:</strong>
                            <p id="revisedPrompt"></p>
                        </div>
                        <div class="image-result-actions">
                            <button class="image-result-btn" onclick="downloadImage()">
                                <i class="fas fa-download"></i> Herunterladen
                            </button>
                            <button class="image-result-btn" onclick="sendImageToChat()">
                                <i class="fas fa-comment"></i> In Chat senden
                            </button>
                            <button class="image-result-btn" onclick="regenerateImage()">
                                <i class="fas fa-sync"></i> Neu generieren
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ? NEW: Create User Modal -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Neuer Benutzer erstellen</h2>
                <button class="close-modal" onclick="closeModal('createUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="createUserError" class="alert alert-error hidden"></div>
                <form id="createUserForm" onsubmit="handleCreateUser(event)">
                    <div class="form-group">
                        <label class="form-label">Benutzername *</label>
                        <input type="text" id="newUsername" class="input-field" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Passwort *</label>
                        <input type="password" id="newPassword" class="input-field" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefonnummer (optional)</label>
                        <input type="text" id="newPhone" class="input-field" placeholder="+49..." />
                        <small style="color: var(--text-secondary); font-size: 12px;">
                            Nur f√∂r WhatsApp-Bot Personalisierung erforderlich
                        </small>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Benutzer erstellen</button>
                </form>
            </div>
        </div>
    </div>

    <div id="manageUserModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Benutzer verwalten</h2>
                <button class="close-modal" onclick="closeModal('manageUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <div class="setting-item">
                        <div class="setting-label">Benutzer</div>
                        <div class="setting-description" id="manageUserMeta">‚Äì</div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">Eigener Prompt</div>
                        <textarea id="managedCustomPrompt" class="input-field" style="min-height: 120px;" placeholder="Eigener Prompt f√ºr diesen Benutzer"></textarea>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">Multi-AI</div>
                        <div class="setting-description">Aktiviert 3 Generatoren + 2 Validatoren</div>
                        <div class="toggle-switch" id="managedMultiAIToggle" onclick="toggleSettingSwitch(this)"></div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">OCR</div>
                        <div class="toggle-switch" id="managedOcrToggle" onclick="toggleSettingSwitch(this)"></div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">MEGA</div>
                        <div class="toggle-switch" id="managedMegaToggle" onclick="toggleSettingSwitch(this)"></div>
                    </div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: space-between; margin-top: 20px;">
                    <button class="btn" style="flex: 1 1 45%;" onclick="resetManagedUserPassword()">
                        <i class="fas fa-key"></i> Passwort zur√ºcksetzen
                    </button>
                    <button class="btn btn-primary" style="flex: 1 1 45%;" onclick="saveManagedUserSettings()">
                        <i class="fas fa-save"></i> Einstellungen speichern
                    </button>
                    <button class="btn btn-danger" style="flex: 1 1 100%;" onclick="deleteManagedUser()">
                        <i class="fas fa-trash"></i> Benutzer l√∂schen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="materialModal" class="modal">
        <div class="modal-content" style="max-width: 720px;">
            <div class="modal-header">
                <h2 class="modal-title" id="materialModalTitle">Material</h2>
                <button class="close-modal" onclick="closeModal('materialModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="material-modal-content" id="materialModalPreview"></div>
                <div class="material-modal-info">
                    <div class="uploader-meta">
                        <div class="profile-avatar" id="materialModalAvatar">U</div>
                        <div>
                            <div id="materialModalUploader">Uploader</div>
                            <div id="materialModalSubject" style="font-size: 12px; color: var(--text-secondary);"></div>
                        </div>
                    </div>
                    <p id="materialModalDescription" style="line-height: 1.6;"></p>
                    <a id="materialModalDownload" class="btn btn-primary" href="#" target="_blank" rel="noopener">
                        <i class="fas fa-download"></i> Datei herunterladen
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // GLOBAL STATE
        let sessionId = localStorage.getItem('sessionId');
        let currentUser = null;
        let currentTheme = localStorage.getItem('theme') || 'dark';
        let currentChatId = null;
        let chats = [];
        let selectedModel = localStorage.getItem('selectedModel') || 'auto';
        let uploadedFiles = [];
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let isGridView = false;
        let currentGeneratedImage = null;
        let codeBlockStore = {}; // ? FIX Bug 2: Store f√ºr HTML-Code-Bl√∂cke
        let codeBlockCounter = 0;
        const ACCESSIBILITY_DEFAULTS = { fontSize: 'medium', highContrast: false, autoFormat: true };
        let userPreferences = { accessibility: { ...ACCESSIBILITY_DEFAULTS } };
        let assistantTypewriterInterval = null;
        let isChatInputCollapsed = false;
        let adminUsersCache = new Map();
        let managedUserId = null;
        let homeworkItems = [];
        let materialItems = [];
        let materialMap = new Map();
        let currentMainView = 'home';
        let currentProfile = null;
        const CURRICULUM_STORAGE_PREFIX = 'curriculum_selection_';
        let curriculumMeta = { states: [], grades: [], stateGradeMap: {} };
        let curriculumSelection = { state: null, grade: null };
        let curriculumSubjects = [];
        let curriculumInitialized = false;
        let isSidebarPinnedHidden = false;

        // SOUND SYSTEM - Professional Audio Effects
        const SoundSystem = {
            audioContext: null,
            masterVolume: 0.3,
            enabled: localStorage.getItem('soundsEnabled') !== 'false',
            
            init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.warn('AudioContext nicht verf√ºgbar:', e);
                }
            },
            
            playTone(frequency, duration, type = 'sine', volume = 1) {
                if (!this.enabled || !this.audioContext) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.type = type;
                oscillator.frequency.value = frequency;
                
                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume * this.masterVolume, this.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            },
            
            playSuccess() {
                // Clean, deep success sound like Samsung TV
                this.playTone(220, 0.1, 'sine', 0.4);
                setTimeout(() => this.playTone(330, 0.15, 'sine', 0.3), 50);
                setTimeout(() => this.playTone(440, 0.2, 'sine', 0.2), 150);
            },
            
            playClick() {
                // Primary button click - bright and clear
                this.playTone(880, 0.06, 'sine', 0.25);
                setTimeout(() => this.playTone(1100, 0.04, 'sine', 0.2), 30);
            },
            
            playTap() {
                // Navigation tap - soft and gentle
                this.playTone(500, 0.05, 'sine', 0.15);
            },
            
            playHover() {
                // Subtle hover feedback - very quiet
                this.playTone(1200, 0.02, 'sine', 0.08);
            },
            
            playNotification() {
                // Notification chime - pleasant bell
                this.playTone(523, 0.12, 'sine', 0.3);
                setTimeout(() => this.playTone(659, 0.15, 'sine', 0.25), 100);
                setTimeout(() => this.playTone(784, 0.1, 'sine', 0.2), 200);
            },
            
            playError() {
                // Error sound - harsh descending
                this.playTone(400, 0.1, 'sawtooth', 0.4);
                setTimeout(() => this.playTone(250, 0.15, 'sawtooth', 0.35), 80);
                setTimeout(() => this.playTone(150, 0.1, 'sawtooth', 0.3), 160);
            },
            
            playSend() {
                // Message send - deeper, more pleasant sound
                this.playTone(220, 0.08, 'sine', 0.3);
                setTimeout(() => this.playTone(280, 0.1, 'sine', 0.25), 50);
                setTimeout(() => this.playTone(330, 0.08, 'sine', 0.2), 100);
            },
            
            playDelete() {
                // Delete - deep warning rumble
                this.playTone(180, 0.1, 'sawtooth', 0.4);
                setTimeout(() => this.playTone(120, 0.12, 'sawtooth', 0.35), 70);
            },
            
            playRename() {
                // Rename/edit - pleasant double chime
                this.playTone(660, 0.05, 'sine', 0.22);
                setTimeout(() => this.playTone(880, 0.06, 'sine', 0.18), 60);
            },
            
            playFileAttach() {
                // File attach - paper snap
                this.playTone(600, 0.04, 'sine', 0.2);
                setTimeout(() => this.playTone(750, 0.05, 'sine', 0.16), 30);
                setTimeout(() => this.playTone(500, 0.03, 'sine', 0.12), 60);
            },
            
            playChatSwitch() {
                // Chat switch - smooth slide
                this.playTone(300, 0.08, 'sine', 0.2);
                setTimeout(() => this.playTone(400, 0.07, 'sine', 0.17), 50);
                setTimeout(() => this.playTone(500, 0.05, 'sine', 0.14), 100);
            },
            
            toggle() {
                this.enabled = !this.enabled;
                localStorage.setItem('soundsEnabled', this.enabled);
                if (this.enabled) {
                    this.playSuccess();
                }
            }
        };
        
        // Initialize sound system
        SoundSystem.init();
        
        // Auto-resume audio context on user interaction
        document.addEventListener('click', () => {
            if (SoundSystem.audioContext && SoundSystem.audioContext.state === 'suspended') {
                SoundSystem.audioContext.resume();
            }
        }, { once: true });

        applyAccessibility(userPreferences.accessibility);

        // Initialize theme
        document.documentElement.setAttribute('data-theme', currentTheme);
        updateThemeIcon();
        updateHeroSnapshot();

        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeIcon();
            updateHighlightTheme();
        }

        function updateThemeIcon() {
            const icon = document.getElementById('themeIcon');
            icon.className = currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        function updateHighlightTheme() {
            const link = document.getElementById('highlight-theme');
            link.href = currentTheme === 'dark'
                ? 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css'
                : 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css';
        }

        function ensureClientSettings(settings = {}) {
            const sanitized = { ...settings };
            sanitized.aliases = Array.isArray(settings.aliases) ? settings.aliases : [];
            sanitized.keywordRouting = {
                mega: Array.isArray(settings?.keywordRouting?.mega) ? settings.keywordRouting.mega : [],
                ocr: Array.isArray(settings?.keywordRouting?.ocr) ? settings.keywordRouting.ocr : []
            };
            sanitized.modelPreferences = {
                priority: Array.isArray(settings?.modelPreferences?.priority) ? settings.modelPreferences.priority : [],
                blacklist: Array.isArray(settings?.modelPreferences?.blacklist) ? settings.modelPreferences.blacklist : [],
                autoFallback: settings?.modelPreferences?.autoFallback !== false
            };
            sanitized.accessibility = {
                fontSize: ['small', 'medium', 'large'].includes(settings?.accessibility?.fontSize)
                    ? settings.accessibility.fontSize
                    : ACCESSIBILITY_DEFAULTS.fontSize,
                highContrast: settings?.accessibility?.highContrast || false,
                autoFormat: settings?.accessibility?.autoFormat !== false
            };
            return { ...sanitized };
        }

        function applyAccessibility(accessibility = {}) {
            const merged = {
                ...ACCESSIBILITY_DEFAULTS,
                ...accessibility
            };
            document.body.dataset.fontSize = merged.fontSize;
            document.body.dataset.contrast = merged.highContrast ? 'high' : 'normal';
            userPreferences.accessibility = merged;
        }

        async function refreshUserPreferences() {
            if (!currentUser || currentUser.role !== 'user') return;
            const userId = currentUser.userId || currentUser.phone;
            if (!userId) return;
            try {
                const res = await fetch(`/api/users/${encodeURIComponent(userId)}/settings`, {
                    headers: { 'x-session-id': sessionId }
                });
                if (res.ok) {
                    const data = await res.json();
                    userPreferences = ensureClientSettings(data.settings || {});
                    applyAccessibility(userPreferences.accessibility);
                    currentProfile = userPreferences.profile;
                    updateSidebarAvatar(currentProfile?.avatarUrl);
                }
            } catch (error) {
                console.error('Konnte User-Einstellungen nicht aktualisieren:', error);
            }
        }

        // AUTH
        async function checkSession() {
            // Ensure sessionId is loaded from localStorage
            if (!sessionId) {
                sessionId = localStorage.getItem('sessionId');
            }
            
            if (!sessionId) {
                showLogin();
                return;
            }

            try {
                const res = await fetch('/api/session', {
                    headers: { 'x-session-id': sessionId }
                });

                if (!res.ok) {
                    // Session invalid, clear it
                    localStorage.removeItem('sessionId');
                    sessionId = null;
                    showLogin();
                    return;
                }

                const data = await res.json();
                const previousUserId = currentUser?.userId || null;
                currentUser = data.user;
                
                // Wenn sich der Benutzer ge√§ndert hat, Eingabefelder leeren
                if (previousUserId && previousUserId !== currentUser.userId) {
                    clearAllInputFields();
                }
                
                // Load user preferences if available
                if (currentUser.settings) {
                    userPreferences = ensureClientSettings(currentUser.settings);
                    applyAccessibility(userPreferences.accessibility);
                }
                
                showDashboard();
            } catch (error) {
                console.error('Session check error:', error);
                localStorage.removeItem('sessionId');
                sessionId = null;
                showLogin();
            }
        }

        function handleAuthSuccess(data) {
            sessionId = data.sessionId;
            localStorage.setItem('sessionId', sessionId);
            currentUser = data.user;

            // Alle Eingabefelder leeren beim Login (f√ºr neuen Benutzer)
            clearAllInputFields();

            if (currentUser.settings) {
                userPreferences = ensureClientSettings(currentUser.settings);
                applyAccessibility(userPreferences.accessibility);
                currentProfile = currentUser.settings.profile || null;
            }

            updateSidebarAvatar(currentProfile?.avatarUrl);
            SoundSystem.playSuccess(); // Clean, deep success sound
            showDashboard();
            
            // Entwurf f√ºr den neuen Benutzer laden (falls vorhanden)
            loadPublicChatDraft();
        }

        // Initialize login form when DOM is ready
        function initLoginForm() {
            const loginForm = document.getElementById('loginForm');
            if (!loginForm) {
                console.error('Login form not found!');
                return;
            }

            const authTabs = document.querySelectorAll('.auth-tab');
            authTabs.forEach((tab) => {
                tab.addEventListener('click', () => {
                    const target = tab.getAttribute('data-target');
                    switchAuthView(target);
                });
            });

            function switchAuthView(target = 'login') {
                authTabs.forEach((tab) => {
                    const isActive = tab.getAttribute('data-target') === target;
                    tab.classList.toggle('active', isActive);
                });
                const loginWrapper = document.getElementById('loginFormWrapper');
                const registerWrapper = document.getElementById('registerFormWrapper');
                if (loginWrapper && registerWrapper) {
                    loginWrapper.classList.toggle('hidden', target !== 'login');
                    registerWrapper.classList.toggle('hidden', target !== 'register');
                }
                const registerError = document.getElementById('registerError');
                const registerSuccess = document.getElementById('registerSuccess');
                registerError?.classList.add('hidden');
                registerSuccess?.classList.add('hidden');
                
                // Alle Eingabefelder leeren beim Wechseln zwischen Login/Register
                clearAllInputFields();
            }

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                e.stopPropagation();

                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;

                console.log('Login form submitted, username:', username);

                if (!username || !password) {
                    showError('loginError', 'Bitte Benutzername und Passwort eingeben');
                    return;
                }

                // Show loading state
                const submitBtn = e.target.querySelector('button[type="submit"]');
                if (!submitBtn) {
                    console.error('Submit button not found!');
                    return;
                }
                
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Anmelden...';

                try {
                    console.log('Sending login request to /api/login...');
                    const res = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });

                    console.log('Login response status:', res.status);

                    if (!res.ok) {
                        const errorData = await res.json().catch(() => ({ error: 'Unbekannter Fehler' }));
                        console.error('Login failed:', errorData);
                        showError('loginError', errorData.error || 'Login fehlgeschlagen');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                        return;
                    }

                    const data = await res.json();
                    console.log('Login response data:', data);

                    if (!data.sessionId || !data.user) {
                        console.error('Invalid response data:', data);
                        showError('loginError', 'Ung√ºltige Antwort vom Server');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                        return;
                    }

                    handleAuthSuccess(data);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                } catch (error) {
                    console.error('Login error:', error);
                    showError('loginError', 'Verbindungsfehler: ' + error.message);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            });

            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = document.getElementById('registerUsername').value.trim();
                    const phone = document.getElementById('registerPhone').value.trim();
                    const password = document.getElementById('registerPassword').value;
                    const registerError = document.getElementById('registerError');
                    const registerSuccess = document.getElementById('registerSuccess');

                    registerError.classList.add('hidden');
                    registerSuccess.classList.add('hidden');

                    if (!username || !password) {
                        registerError.textContent = 'Bitte alle Pflichtfelder ausf√ºllen';
                        registerError.classList.remove('hidden');
                        return;
                    }

                    if (password.length < 6) {
                        registerError.textContent = 'Passwort muss mindestens 6 Zeichen haben';
                        registerError.classList.remove('hidden');
                        return;
                    }

                    const submitBtn = registerForm.querySelector('button[type="submit"]');
                    const originalBtnText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registriere...';

                    try {
                        const res = await fetch('/api/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                username,
                                phone: phone || null,
                                password
                            })
                        });

                        const data = await res.json();
                        if (!res.ok) {
                            registerError.textContent = data.error || 'Registrierung fehlgeschlagen';
                            registerError.classList.remove('hidden');
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnText;
                            return;
                        }

                        registerSuccess.textContent = 'Konto erstellt ‚Äì Dashboard wird geladen...';
                        registerSuccess.classList.remove('hidden');
                        handleAuthSuccess(data);
                    } catch (error) {
                        registerError.textContent = 'Verbindungsfehler: ' + error.message;
                        registerError.classList.remove('hidden');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                    }
                });
            }

            switchAuthView('login');
        }

        function getChatsStorageKey() {
            return currentUser ? `chats_${currentUser.username}` : 'chats_default';
        }

        function normalizeChatId(id, fallbackId = null) {
            if (typeof id === 'string' && id.trim()) {
                return id.trim();
            }
            if (typeof id === 'number' && !Number.isNaN(id)) {
                return id.toString();
            }
            return fallbackId || `chat_${Date.now()}`;
        }

        function normalizeChatEntry(chat = {}, index = 0) {
            const fallbackId = chat.createdAt
                ? `chat_${chat.createdAt}`
                : `chat_${Date.now()}_${index}`;
            const normalizedId = normalizeChatId(chat.id, fallbackId);
            return {
                ...chat,
                id: normalizedId,
                title: chat.title || 'Neuer Chat',
                messages: Array.isArray(chat.messages) ? chat.messages : [],
                createdAt: chat.createdAt || Date.now(),
                updatedAt: chat.updatedAt || chat.createdAt || Date.now()
            };
        }

        function ensureChatCollectionStructure(collection = []) {
            if (!Array.isArray(collection)) return [];
            return collection.map((chat, index) => normalizeChatEntry(chat, index));
        }

        function loadChatsFromStorage() {
            const storedChats = localStorage.getItem(getChatsStorageKey());
            if (!storedChats) {
                chats = [];
                return;
            }
            try {
                const parsed = JSON.parse(storedChats);
                chats = ensureChatCollectionStructure(parsed);
                saveChats(); // persist normalization (ids/messages)
            } catch (error) {
                console.error('Chats konnten nicht geladen werden:', error);
                chats = [];
                localStorage.removeItem(getChatsStorageKey());
            }
        }

        function clearAllInputFields() {
            // Chat-Eingabefeld leeren
            const chatInput = document.getElementById('chatInput');
            if (chatInput) chatInput.value = '';

            // √ñffentlicher Chat-Eingabefeld leeren (aber Entwurf f√ºr aktuellen Benutzer behalten)
            const publicChatInput = document.getElementById('publicChatInput');
            if (publicChatInput) {
                // Entwurf f√ºr aktuellen Benutzer speichern, bevor geleert wird
                if (currentUser && currentUser.userId) {
                    savePublicChatDraft();
                }
                publicChatInput.value = '';
            }

            // Hausaufgaben-Felder leeren
            const homeworkSubject = document.getElementById('homeworkSubject');
            const homeworkDescription = document.getElementById('homeworkDescription');
            if (homeworkSubject) homeworkSubject.value = '';
            if (homeworkDescription) homeworkDescription.value = '';

            // Material-Felder leeren
            const materialTitle = document.getElementById('materialTitle');
            const materialSubject = document.getElementById('materialSubject');
            const materialDescription = document.getElementById('materialDescription');
            const materialFile = document.getElementById('materialFile');
            if (materialTitle) materialTitle.value = '';
            if (materialSubject) materialSubject.value = '';
            if (materialDescription) materialDescription.value = '';
            if (materialFile) materialFile.value = '';

            // Alle anderen Eingabefelder im Dashboard zur√ºcksetzen
            const homeworkForm = document.getElementById('homeworkForm');
            if (homeworkForm) homeworkForm.reset();

            const materialForm = document.getElementById('materialForm');
            if (materialForm) materialForm.reset();
        }

        function showLogin() {
            const loginPage = document.getElementById('loginPage');
            const dashboardPage = document.getElementById('dashboardPage');
            
            // Stoppe Polling beim Anzeigen der Login-Seite
            stopPublicChatPolling();
            
            // Alle Eingabefelder leeren beim Anzeigen der Login-Seite
            clearAllInputFields();
            
            if (loginPage) loginPage.classList.remove('hidden');
            if (dashboardPage) dashboardPage.classList.add('hidden');
        }

        async function showDashboard() {
            const loginPage = document.getElementById('loginPage');
            const dashboardPage = document.getElementById('dashboardPage');
            
            if (!loginPage || !dashboardPage) {
                console.error('Login or Dashboard page element not found!');
                return;
            }

            if (!currentUser) {
                console.error('No current user set!');
                showLogin();
                return;
            }

            console.log('Showing dashboard for user:', currentUser.username);
            
            loginPage.classList.add('hidden');
            dashboardPage.classList.remove('hidden');

            const avatar = document.getElementById('userAvatar');
            const name = document.getElementById('userName');
            const role = document.getElementById('userRole');

            if (avatar) avatar.textContent = currentUser.username.charAt(0).toUpperCase();
            if (name) name.textContent = currentUser.username;
            if (role) role.textContent = currentUser.role === 'admin' ? 'Administrator' : 'Benutzer';

            if (currentUser.settings) {
                userPreferences = ensureClientSettings(currentUser.settings);
                applyAccessibility(userPreferences.accessibility);
                currentProfile = userPreferences.profile;
            } else {
                await refreshUserPreferences();
            }

            updateSidebarAvatar(currentProfile?.avatarUrl);

            loadChatsFromStorage();
            initializeModels();
            loadChats();

            // Event delegation for chat list - NEU IMPLEMENTIERT
            const chatList = document.getElementById('chatList');
            if (chatList) {
                // Entferne alle Event-Listener durch Ersetzen des Elements
                const parent = chatList.parentNode;
                const newChatList = chatList.cloneNode(false);
                parent.replaceChild(newChatList, chatList);
                
                // NEUER Event-Handler - komplett neu implementiert
                newChatList.addEventListener('click', function(e) {
                    // Pr√ºfe zuerst auf Action-Buttons (L√∂schen/Umbenennen)
                    const clickedElement = e.target;
                    
                    // Pr√ºfe ob auf Button oder Icon geklickt wurde
                    let actionBtn = null;
                    if (clickedElement.classList.contains('chat-item-action')) {
                        actionBtn = clickedElement;
                    } else if (clickedElement.closest('.chat-item-action')) {
                        actionBtn = clickedElement.closest('.chat-item-action');
                    }
                    
                    if (actionBtn) {
                        // STOPPE ALLE Events sofort
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        
                        const action = actionBtn.getAttribute('data-action');
                        const chatId = actionBtn.getAttribute('data-chat-id');
                        
                        if (action === 'delete' && chatId) {
                            deleteChat(chatId);
                            return false;
                        } else if (action === 'rename' && chatId) {
                            renameChat(chatId);
                            return false;
                        }
                        return false;
                    }
                    
                    // Pr√ºfe ob auf Actions-Container geklickt wurde
                    if (clickedElement.closest('.chat-item-actions')) {
                        e.preventDefault();
                        e.stopPropagation();
                        return false;
                    }
                    
                    // Nur wenn NICHT auf Action geklickt wurde, Chat √∂ffnen
                    const chatItem = clickedElement.closest('.chat-item');
                    if (chatItem) {
                        const chatId = chatItem.getAttribute('data-chat-id');
                        if (chatId) {
                            switchToChat(chatId);
                        }
                    }
                }, true); // useCapture = true f√ºr fr√ºhe Event-Erfassung
            }

            if (chats.length === 0) {
                createNewChat();
            } else {
                switchToChat(chats[0].id);
            }

            if (currentUser.role === 'user') {
                refreshUserPreferences();
            }

            switchMainView('home');
            loadHomeworkBoard();
            loadMaterialsGallery();
            fetchOwnProfile();
            loadPublicChat();
            startPublicChatPolling(); // Starte Live-Updates f√ºr √∂ffentlichen Chat
            loadWebuntisStatus();
            loadAdminAnnouncement();
            // Remove curriculum planner initialization
            updateSidebarToggleBtn();
            
            // Initialize sound effects for buttons
            initializeSoundEffects();
            
            // Fix mobile UI on first load
            fixMobileUI();
        }
        
        // Sound Effects System - Add sounds to all interactive elements
        function initializeSoundEffects() {
            // Button clicks
            document.addEventListener('click', (e) => {
                const target = e.target;
                const button = target.closest('button');
                const link = target.closest('a.btn');
                
                if (button && !button.hasAttribute('data-no-sound')) {
                    if (button.classList.contains('btn-primary') || button.classList.contains('send-btn')) {
                        SoundSystem.playClick();
                    } else if (button.classList.contains('chat-item-action')) {
                        const action = button.getAttribute('data-action');
                        if (action === 'delete') {
                            SoundSystem.playDelete();
                        } else if (action === 'rename') {
                            SoundSystem.playRename();
                        } else {
                            SoundSystem.playTap();
                        }
                    } else if (button.classList.contains('close-modal')) {
                        SoundSystem.playTap();
                    } else if (button.onclick && button.onclick.toString().includes('document.getElementById') && button.onclick.toString().includes('fileInput')) {
                        SoundSystem.playFileAttach();
                    } else {
                        SoundSystem.playTap();
                    }
                } else if (link) {
                    SoundSystem.playClick();
                }
            });
            
            // Input focus
            document.addEventListener('focus', (e) => {
                if (e.target.matches('input, textarea, select') && !e.target.hasAttribute('data-no-sound')) {
                    SoundSystem.playHover();
                }
            }, true);
            
            // Hover effects on interactive elements
            document.addEventListener('mouseenter', (e) => {
                if (e.target.matches('button:not([disabled]), a.btn, .chat-item, .card-panel')) {
                    // Subtle hover sound only on certain elements
                    if (e.target.matches('.chat-item, .card-panel')) {
                        // Very subtle, only occasionally
                        if (Math.random() > 0.9) {
                            SoundSystem.playHover();
                        }
                    }
                }
            }, true);
        }
        
        // Fix Mobile UI Issues
        function fixMobileUI() {
            // Fix viewport on mobile
            const viewport = document.querySelector('meta[name="viewport"]');
            if (!viewport) {
                const meta = document.createElement('meta');
                meta.name = 'viewport';
                meta.content = 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover';
                document.head.appendChild(meta);
            } else {
                viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover';
            }
            
            // Prevent zoom on double tap (iOS)
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (e) => {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // Fix initial render on mobile
            if (window.innerWidth <= 768) {
                document.body.style.overflow = 'hidden';
                setTimeout(() => {
                    document.body.style.overflow = '';
                    window.scrollTo(0, 0);
                }, 100);
            }
            
            // Ensure proper mobile layout
            const appContainer = document.querySelector('.app-container');
            if (appContainer && window.innerWidth <= 768) {
                appContainer.style.minHeight = '100vh';
                appContainer.style.minHeight = '100dvh'; // Dynamic viewport height
            }
            
            // Fix sidebar on mobile
            if (window.innerWidth <= 1024) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.classList.add('collapsed');
                }
            }
        }

        // MODEL SELECTOR
        function initializeModels() {
            const models = [
                {
                    category: 'Auto',
                    models: [
                        { id: 'auto', name: 'Auto', desc: 'Automatische Modellwahl basierend auf Komplexit√∂t' }
                    ]
                },
                {
                    category: 'Spezial',
                    models: [
                        { id: 'schoolgpt', name: 'SchoolGPT', desc: 'Optimiert f√∂r Sch√∂ler & Hausaufgaben' }
                    ]
                },
                {
                    category: 'Generator KIs',
                    models: [
                        { id: 'gemini-2.5-flash', name: 'Gemini 2.5 Flash', desc: 'Schnell & pr√∂zise (Google)' },
                        { id: 'gemini-2.5-flash-lite', name: 'Gemini Flash Lite', desc: 'Noch schneller (Google)' },
                        { id: 'deepseek-r1', name: 'DeepSeek R1', desc: 'Deep Reasoning & Logik' },
                        { id: 'deepseek-r1-distill', name: 'DeepSeek R1 Distill', desc: 'Kompakte Version' },
                        { id: 'llama-4-scout', name: 'Llama 4 Scout', desc: 'Metas neuestes Modell' },
                        { id: 'llama-3.3-70b', name: 'Llama 3.3 70B', desc: 'Vielseitig & leistungsstark' }
                    ]
                },
                {
                    category: 'Validator KIs',
                    models: [
                        { id: 'qwen-3-32b', name: 'Qwen 3 32B', desc: 'Pr√∂zise Bewertung' }
                    ]
                },
                {
                    category: 'Synthesizer',
                    models: [
                        { id: 'gpt-oss-120b', name: 'GPT-OSS 120B', desc: 'Kombiniert beste Antworten' }
                    ]
                }
            ];

            const dropdown = document.getElementById('modelDropdown');
            dropdown.innerHTML = models.map(cat => `
                <div class="model-category">
                    <div class="model-category-title">${cat.category}</div>
                    ${cat.models.map(model => `
                        <div class="model-option ${selectedModel === model.id ? 'active' : ''}" onclick="selectModel('${model.id}', '${model.name}')">
                            <div class="model-option-name">${model.name}</div>
                            <div class="model-option-desc">${model.desc}</div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
            updateSelectedModelName();
        }

        function toggleModelDropdown() {
            const dropdown = document.getElementById('modelDropdown');
            dropdown.classList.toggle('show');
        }

        function selectModel(modelId, modelName) {
            selectedModel = modelId;
            localStorage.setItem('selectedModel', modelId);
            updateSelectedModelName();
            toggleModelDropdown();
        }

        function updateSelectedModelName() {
            const btn = document.getElementById('selectedModelName');
            const modelNames = {
                'auto': 'Auto',
                'schoolgpt': 'SchoolGPT',
                'gemini-2.5-flash': 'Gemini 2.5',
                'gemini-2.5-flash-lite': 'Gemini Lite',
                'deepseek-r1': 'DeepSeek R1',
                'deepseek-r1-distill': 'DeepSeek Distill',
                'llama-4-scout': 'Llama 4 Scout',
                'llama-3.3-70b': 'Llama 3.3',
                'qwen-3-32b': 'Qwen 3',
                'gpt-oss-120b': 'GPT-OSS'
            };
            btn.textContent = modelNames[selectedModel] || 'Auto';
        }

        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('modelDropdown');
            const btn = document.querySelector('.model-selector-btn');
            if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // CHAT MANAGEMENT
        function createNewChat() {
            SoundSystem.playClick(); // New chat sound
            const chat = {
                id: 'chat_' + Date.now(),
                title: 'Neuer Chat',
                messages: [],
                createdAt: Date.now(),
                updatedAt: Date.now()
            };

            chats.unshift(chat);
            currentChatId = chat.id; // ? FIX: Setze currentChatId SOFORT
            saveChats();
            loadChats();

            // ? FIX: Sofort leeren Chat anzeigen
            document.getElementById('chatTitle').textContent = chat.title;
            renderMessages([]);

            // ? FIX: Grid View deaktivieren falls aktiv
            if (isGridView) {
                isGridView = false;
                document.getElementById('gridViewBtn').classList.remove('active');
                document.getElementById('chatInputWrapper').style.display = 'block';
            }
        }

        function loadChats() {
            const chatList = document.getElementById('chatList');

            if (chats.length === 0) {
                chatList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 14px;">Keine Chats vorhanden</div>';
                return;
            }

            const normalizedCurrentId = normalizeChatId(currentChatId || '');
            chatList.innerHTML = chats.map(chat => {
                const normalizedId = normalizeChatId(chat.id);
                return `
                <div class="chat-item ${normalizedId === normalizedCurrentId ? 'active' : ''}" data-chat-id="${normalizedId}">
                    <div class="chat-item-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="chat-item-content">
                        <div class="chat-item-title">${escapeHtml(chat.title)}</div>
                        <div class="chat-item-preview">${chat.messages.length} Nachrichten</div>
                    </div>
                    <div class="chat-item-actions">
                        <button class="chat-item-action chat-rename-btn" data-action="rename" data-chat-id="${normalizedId}" title="Umbenennen" type="button">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="chat-item-action chat-delete-btn" data-action="delete" data-chat-id="${normalizedId}" title="L√∂schen" type="button">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `;
            }).join('');
            
            // Direkte Event-Listener auf die Buttons setzen
            chatList.querySelectorAll('.chat-delete-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    const chatId = this.getAttribute('data-chat-id');
                    if (chatId) {
                        deleteChat(chatId);
                    }
                    return false;
                }, true);
            });
            
            chatList.querySelectorAll('.chat-rename-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    const chatId = this.getAttribute('data-chat-id');
                    if (chatId) {
                        renameChat(chatId);
                    }
                    return false;
                }, true);
            });
        }

        function switchToChat(chatId) {
            const normalizedId = normalizeChatId(chatId);
            currentChatId = normalizedId;
            const chat = chats.find(c => normalizeChatId(c.id) === normalizedId);

            if (!chat) return;

            SoundSystem.playChatSwitch(); // Chat switch sound
            document.getElementById('chatTitle').textContent = chat.title;
            loadChats();
            renderMessages(chat.messages);
        }

        function deleteChat(chatId) {
            // VALIDIERUNG
            if (!chatId) {
                console.error('deleteChat: Keine Chat-ID √ºbergeben');
                return;
            }
            
            // BEST√ÑTIGUNG
            if (!confirm('Chat wirklich l√∂schen?')) {
                return;
            }

            SoundSystem.playDelete(); // Delete sound
            
            const normalizedId = normalizeChatId(chatId);
            console.log('L√∂sche Chat:', normalizedId);
            
            // ENTFERNE CHAT
            const beforeLength = chats.length;
            chats = chats.filter(c => normalizeChatId(c.id) !== normalizedId);
            const afterLength = chats.length;
            
            if (beforeLength === afterLength) {
                console.warn('Chat wurde nicht gefunden:', normalizedId);
                return;
            }
            
            saveChats();
            loadChats();

            // WECHSLE ZU ANDEREM CHAT WENN GEL√ñSCHTER CHAT AKTIV WAR
            if (currentChatId === normalizedId) {
                if (chats.length > 0) {
                    switchToChat(chats[0].id);
                } else {
                    createNewChat();
                }
            }
        }

        function deleteMessage(messageIndex) {
            const chat = getCurrentChat();
            if (!chat || !chat.messages || messageIndex < 0 || messageIndex >= chat.messages.length) return;
            
            const message = chat.messages[messageIndex];
            if (message.role !== 'user') return; // Only allow deleting user messages
            
            if (!confirm('Nachricht wirklich l√∂schen?')) return;
            
            SoundSystem.playDelete();
            chat.messages.splice(messageIndex, 1);
            chat.updatedAt = Date.now();
            saveChats();
            renderMessages(chat.messages);
        }

        function renameChat(chatId) {
            const normalizedId = normalizeChatId(chatId);
            const chat = chats.find(c => normalizeChatId(c.id) === normalizedId);
            if (!chat) return;

            SoundSystem.playRename(); // Rename sound
            const newTitle = prompt('Neuer Titel:', chat.title);
            if (newTitle && newTitle.trim()) {
                chat.title = newTitle.trim();
                chat.updatedAt = Date.now();
                saveChats();
                loadChats();
                if (currentChatId === normalizedId) {
                    document.getElementById('chatTitle').textContent = newTitle;
                }
            }
        }

        function saveChats() {
            chats = ensureChatCollectionStructure(chats);
            localStorage.setItem(getChatsStorageKey(), JSON.stringify(chats));
        }

        function getCurrentChat() {
            const normalizedId = normalizeChatId(currentChatId || '');
            return chats.find(c => normalizeChatId(c.id) === normalizedId);
        }

        // MESSAGES
        function renderMessages(messages = [], options = {}) {
            const container = document.getElementById('chatMessages');
            if (!container) return;

            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="welcome-screen">
                        <div class="welcome-title">Wie kann ich dir helfen?</div>
                        <div class="welcome-subtitle">Stelle eine Frage oder w√∂hle eine Vorschl√∂ge</div>
                        <div class="suggestion-chips">
                            <div class="suggestion-chip" onclick="useSuggestion('Erkl√∂re mir Photosynthese')">
                                <div class="suggestion-icon">üå±</div>
                                <div class="suggestion-text">Erkl√∂re mir Photosynthese</div>
                            </div>
                            <div class="suggestion-chip" onclick="useSuggestion('Hilf mir bei Mathe-Hausaufgaben')">
                                <div class="suggestion-icon">üßÆ</div>
                                <div class="suggestion-text">Hilf mir bei Mathe-Hausaufgaben</div>
                            </div>
                            <div class="suggestion-chip" onclick="useSuggestion('√∂bersetze einen Text')">
                                <div class="suggestion-icon">üåê</div>
                                <div class="suggestion-text">√∂bersetze einen Text</div>
                            </div>
                            <div class="suggestion-chip" onclick="useSuggestion('Schreibe HTML Code')">
                                <div class="suggestion-icon">üíª</div>
                                <div class="suggestion-text">Schreibe HTML Code</div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            const autoFormat = userPreferences?.accessibility?.autoFormat !== false;
            const shouldAnimateLatest = Boolean(
                options.animateLatest && messages[messages.length - 1]?.role === 'assistant'
            );

            stopAssistantTypewriter();

            container.innerHTML = messages
                .map((msg, index) => {
                    const userInitial = currentUser?.username?.charAt(0).toUpperCase() || 'U';
                    const content = msg.role === 'user'
                        ? formatUserMessage(msg.content, autoFormat)
                        : formatAssistantMessage(msg.content, autoFormat);
                    const deleteButton = msg.role === 'user' 
                        ? `<button class="message-delete-btn" onclick="deleteMessage(${index})" title="Nachricht l√∂schen"><i class="fas fa-trash"></i></button>`
                        : '';
                    return `
                        <div class="message" data-message-index="${index}">
                            <div class="message-header">
                                <div class="message-avatar ${msg.role}">${msg.role === 'user' ? userInitial : 'AI'}</div>
                                <div class="message-sender">${msg.role === 'user' ? 'Du' : 'Aeon'}</div>
                                ${deleteButton}
                            </div>
                            <div class="message-content">${content}</div>
                        </div>
                    `;
                })
                .join('');

            const highlightBlocks = (selector = 'pre code') => {
                container.querySelectorAll(selector).forEach((block) => {
                    hljs.highlightElement(block);
                });
            };

            const lastMessageElement = shouldAnimateLatest
                ? container.querySelector('.message:last-child')
                : null;
            initializeArtifactsWithin(container, lastMessageElement);

            if (shouldAnimateLatest) {
                highlightBlocks('.message:not(:last-child) pre code');
                const lastMessageContent = lastMessageElement?.querySelector('.message-content');
                if (lastMessageContent) {
                    const finalHtml = lastMessageContent.innerHTML;
                    // Warte kurz, damit vorherige Animationen abgeschlossen sind
                    setTimeout(() => {
                        runAssistantTypewriterAnimation(lastMessageContent, finalHtml, () => {
                            highlightBlocks('.message:last-child pre code');
                            initializeArtifactsWithin(lastMessageContent);
                            scrollToBottom();
                        });
                        scrollToBottom();
                    }, 50);
                } else {
                    highlightBlocks();
                    scrollToBottom();
                }
            } else {
                highlightBlocks();
                scrollToBottom();
            }
        }

        function initializeArtifactsWithin(root = document, skipWithin = null) {
            if (!root) return;
            const artifacts = root.querySelectorAll('.artifact-container');
            artifacts.forEach((artifact) => {
                if (skipWithin && skipWithin.contains(artifact)) {
                    return;
                }
                const artifactId = artifact.id;
                if (artifactId) {
                    initArtifactSplitter(artifactId);

                    const preview = document.getElementById(artifactId + '_preview');
                    const editor = document.getElementById(artifactId + '_editor');
                    if (preview && editor && !preview.srcdoc) {
                        const code = codeBlockStore[artifactId];
                        if (code) {
                            preview.srcdoc = code;
                        }
                    }
                }
            });
        }

        function stopAssistantTypewriter() {
            if (assistantTypewriterInterval) {
                clearInterval(assistantTypewriterInterval);
                assistantTypewriterInterval = null;
            }
        }

        function runAssistantTypewriterAnimation(targetEl, finalHtml, onComplete) {
            if (!targetEl) {
                if (onComplete) onComplete();
                return;
            }

            stopAssistantTypewriter();

            const temp = document.createElement('div');
            temp.innerHTML = finalHtml;
            const plainText = temp.textContent || temp.innerText || '';

            if (!plainText.trim()) {
                targetEl.innerHTML = finalHtml;
                if (onComplete) onComplete();
                return;
            }

            targetEl.innerHTML = '<div class="assistant-typing"></div>';
            const typingNode = targetEl.querySelector('.assistant-typing');
            if (!typingNode) {
                targetEl.innerHTML = finalHtml;
                if (onComplete) onComplete();
                return;
            }

            let index = 0;
            const totalChars = plainText.length;
            const charsPerStep = totalChars > 1500 ? 4 : totalChars > 800 ? 3 : 2;
            const stepDelay = totalChars > 1500 ? 10 : totalChars > 800 ? 14 : 18;

            assistantTypewriterInterval = setInterval(() => {
                index = Math.min(index + charsPerStep, totalChars);
                typingNode.textContent = plainText.slice(0, index);
                scrollToBottom();

                if (index >= totalChars) {
                    stopAssistantTypewriter();
                    targetEl.innerHTML = finalHtml;
                    if (onComplete) onComplete();
                    scrollToBottom();
                }
            }, stepDelay);
        }

        function useSuggestion(text) {
            document.getElementById('chatInput').value = text;
            document.getElementById('chatInput').focus();
        }

        function formatUserMessage(content, autoFormat) {
            if (autoFormat) {
                return escapeHtml(content).replace(/\n/g, '<br>');
            }
            return `<pre>${escapeHtml(content)}</pre>`;
        }

        function formatAssistantMessage(content, autoFormat) {
            if (autoFormat) {
                return processMarkdown(content);
            }
            return `<pre>${escapeHtml(content)}</pre>`;
        }

        function formatAliasList(aliases = []) {
            if (!Array.isArray(aliases) || aliases.length === 0) return '';
            return aliases.map(alias => `${alias.shortcut} => ${alias.prompt}`).join('\n');
        }

        function parseAliasInput(value = '') {
            return value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .map(line => {
                    const [shortcut, ...promptParts] = line.split('=>');
                    return {
                        shortcut: (shortcut || '').trim(),
                        prompt: promptParts.join('=>').trim()
                    };
                })
                .filter(item => item.shortcut && item.prompt);
        }

        function parseKeywordInput(value = '') {
            return value
                .split(',')
                .map(entry => entry.trim())
                .filter(Boolean);
        }

        function getSelectedValues(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return [];
            return Array.from(select.selectedOptions).map(option => option.value);
        }

        function setSelectValues(selectId, values = []) {
            const select = document.getElementById(selectId);
            if (!select) return;
            const selectedSet = new Set(values);
            Array.from(select.options).forEach(option => {
                option.selected = selectedSet.has(option.value);
            });
        }

        function setToggleState(elementId, isActive) {
            const el = document.getElementById(elementId);
            if (!el) return;
            if (isActive) {
                el.classList.add('active');
            } else {
                el.classList.remove('active');
            }
        }

        function getToggleState(elementId) {
            const el = document.getElementById(elementId);
            return el ? el.classList.contains('active') : false;
        }

        function addMessage(role, content, options = {}) {
            const chat = getCurrentChat();
            if (!chat) return;

            chat.messages.push({
                role,
                content,
                timestamp: Date.now(),
            });

            if (chat.messages.length === 2) {
                const firstUserMessage = chat.messages.find((m) => m.role === 'user');
                if (firstUserMessage) {
                    chat.title =
                        firstUserMessage.content.substring(0, 50) +
                        (firstUserMessage.content.length > 50 ? '...' : '');
                }
            }

            chat.updatedAt = Date.now();
            saveChats();
            loadChats();
            const shouldAnimate = options.animate === true && role === 'assistant';
            renderMessages(chat.messages, { animateLatest: shouldAnimate });
        }

        function addTypingIndicator() {
            const container = document.getElementById('chatMessages');
            const indicator = document.createElement('div');
            indicator.className = 'message';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar assistant">AI</div>
                    <div class="message-sender">Aeon</div>
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-star"></div>
                    </div>
                </div>
            `;
            container.appendChild(indicator);
            scrollToBottom();
        }

        // Live Coding Animation
        let liveCodingAnimation = null;
        let liveCodingContent = '';

        function addLiveCodingIndicator() {
            const container = document.getElementById('chatMessages');
            const indicator = document.createElement('div');
            indicator.className = 'message';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar assistant">AI</div>
                    <div class="message-sender">Aeon</div>
                </div>
                <div class="message-content">
                    <div class="live-coding-box">
                        <div class="live-coding-header">
                            <div class="live-coding-icon"></div>
                            <span>Programmiere...</span>
                        </div>
                        <div class="live-coding-content" id="liveCodingContent">
                            <span class="live-coding-cursor"></span>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(indicator);
            scrollToBottom();
            liveCodingContent = '';
        }

        function updateLiveCodingAnimation(codeText, onComplete) {
            const contentElement = document.getElementById('liveCodingContent');
            if (!contentElement) {
                if (onComplete) onComplete();
                return;
            }

            // Wenn neuer Code kommt, starte die Animation
            if (codeText && codeText.length > liveCodingContent.length) {
                const startIndex = liveCodingContent.length;
                const targetLength = codeText.length;
                const totalChars = targetLength - startIndex;
                
                // Adaptive Geschwindigkeit: Mehr Zeichen auf einmal f√ºr l√§ngere Code-Bl√∂cke
                // F√ºr sehr lange Code-Bl√∂cke, mache die Animation schneller, um Einfrieren zu vermeiden
                const charsPerStep = totalChars > 1000 ? 5 : totalChars > 500 ? 3 : totalChars > 200 ? 2 : 1;
                const stepDelay = totalChars > 1000 ? 1 : totalChars > 500 ? 2 : totalChars > 200 ? 3 : 4; // 1-4ms pro Schritt
                
                if (liveCodingAnimation) {
                    clearInterval(liveCodingAnimation);
                    liveCodingAnimation = null;
                }

                let currentIndex = startIndex;
                let lastScrollTime = 0;
                let animationComplete = false;

                liveCodingAnimation = setInterval(() => {
                    if (currentIndex < targetLength && !animationComplete) {
                        currentIndex = Math.min(currentIndex + charsPerStep, targetLength);
                        liveCodingContent = codeText.substring(0, currentIndex);
                        contentElement.innerHTML = escapeHtml(liveCodingContent) + '<span class="live-coding-cursor"></span>';
                        
                        // Scroll nur alle 50ms f√ºr bessere Performance
                        const now = Date.now();
                        if (now - lastScrollTime > 50) {
                            scrollToBottom();
                            lastScrollTime = now;
                        }
                    } else if (!animationComplete) {
                        // Animation abgeschlossen
                        animationComplete = true;
                        clearInterval(liveCodingAnimation);
                        liveCodingAnimation = null;
                        liveCodingContent = codeText;
                        contentElement.innerHTML = escapeHtml(liveCodingContent);
                        scrollToBottom();
                        
                        // Warte kurz, bevor onComplete aufgerufen wird, um sicherzustellen, dass alles gerendert ist
                        setTimeout(() => {
                            if (onComplete) onComplete();
                        }, 50);
                    }
                }, stepDelay);
            } else if (codeText && codeText.length === liveCodingContent.length) {
                // Code ist bereits vollst√§ndig
                liveCodingContent = codeText;
                contentElement.innerHTML = escapeHtml(codeText);
                if (onComplete) {
                    setTimeout(() => onComplete(), 50);
                }
            } else {
                // Wenn Code vollst√§ndig ist, zeige alles an
                liveCodingContent = codeText || '';
                contentElement.innerHTML = escapeHtml(liveCodingContent);
                if (onComplete) {
                    setTimeout(() => onComplete(), 50);
                }
            }
        }

        function stopLiveCodingAnimation() {
            if (liveCodingAnimation) {
                clearInterval(liveCodingAnimation);
                liveCodingAnimation = null;
            }
            // Stelle sicher, dass der Content vollst√§ndig angezeigt wird
            const contentElement = document.getElementById('liveCodingContent');
            if (contentElement && liveCodingContent) {
                contentElement.innerHTML = escapeHtml(liveCodingContent);
            }
        }

        function detectCodeInMessage(message) {
            // Erkenne Code-Bl√∂cke in der Nachricht
            const codeBlockRegex = /```[\s\S]*?```/g;
            const inlineCodeRegex = /`[^`]+`/g;
            const hasCodeBlocks = codeBlockRegex.test(message);
            const hasInlineCode = inlineCodeRegex.test(message);
            
            // Wenn Code-Bl√∂cke vorhanden sind, extrahiere den ersten
            if (hasCodeBlocks) {
                const matches = message.match(codeBlockRegex);
                if (matches && matches.length > 0) {
                    // Entferne die Markdown-Code-Block-Syntax
                    const codeBlock = matches[0].replace(/```[\w]*\n?/g, '').replace(/```/g, '').trim();
                    return codeBlock;
                }
            }
            
            return null;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
            stopLiveCodingAnimation();
        }

        // SEND MESSAGE (Fixed to prevent freezing)
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message && uploadedFiles.length === 0) return;

            const chat = getCurrentChat();
            if (!chat) return;

            const sendBtn = document.getElementById('sendBtn');

            // Prevent multiple simultaneous requests
            if (sendBtn.disabled) return;

            SoundSystem.playSend(); // Send sound effect
            
            // Process images with OCR if any
            let processedMessage = message;
            let processedFiles = [];
            
            if (uploadedFiles.length > 0) {
                for (const file of uploadedFiles) {
                    if (file.type && file.type.startsWith('image/')) {
                        try {
                            // Send image for OCR processing
                            const formData = new FormData();
                            const blob = await fetch(file.data).then(r => r.blob());
                            formData.append('image', blob, file.name);
                            
                            const ocrRes = await fetch('/api/ocr', {
                                method: 'POST',
                                headers: { 'x-session-id': sessionId },
                                body: formData
                            });
                            
                            if (ocrRes.ok) {
                                const ocrData = await ocrRes.json();
                                if (ocrData.text && ocrData.text.trim()) {
                                    processedMessage += `\n\n[Bildinhalt aus ${file.name}]:\n${ocrData.text}`;
                                }
                            }
                        } catch (error) {
                            console.error('OCR error:', error);
                        }
                    }
                    processedFiles.push(file);
                }
            }

            const messageText = processedMessage;
            const filesToSend = [...uploadedFiles]; // Keep copy for API call
            
            // WICHTIG: Input sofort leeren, damit andere User den Text nicht sehen
            input.value = '';
            input.style.height = 'auto';

            uploadedFiles = [];
            const filePreview = document.getElementById('filePreview');
            if (filePreview) filePreview.innerHTML = '';

            sendBtn.disabled = true;
            sendBtn.style.opacity = '0.6';
            sendBtn.style.pointerEvents = 'none';

            // Pr√ºfe, ob die Nachricht Code-Anfragen enth√§lt (z.B. "schreibe code", "programmiere", etc.)
            const codeKeywords = ['code', 'programmiere', 'schreibe', 'erstelle', 'schreibe code', 'programm', 'funktion', 'script', 'html', 'css', 'javascript', 'js', 'tic tac toe', 'spiel'];
            const hasCodeRequest = codeKeywords.some(keyword => 
                messageText.toLowerCase().includes(keyword.toLowerCase())
            );

            if (hasCodeRequest) {
                addLiveCodingIndicator();
            } else {
                addTypingIndicator();
            }

            // Use requestAnimationFrame to prevent UI blocking
            requestAnimationFrame(async () => {
                let timeoutId = null;
                try {
                    const controller = new AbortController();
                    timeoutId = setTimeout(() => controller.abort(), 120000); // 2 min timeout

                    // Sende Bilder als FormData wenn vorhanden
                    let res;
                    if (filesToSend.length > 0) {
                        const formData = new FormData();
                        formData.append('message', messageText);
                        formData.append('chatId', currentChatId || '');
                        formData.append('model', selectedModel || 'auto');
                        
                        // F√ºge alle Bilder hinzu
                        for (const file of filesToSend) {
                            if (file.type && file.type.startsWith('image/')) {
                                const blob = await fetch(file.data).then(r => r.blob());
                                formData.append('images', blob, file.name);
                            }
                        }
                        
                        res = await fetch('/api/chat', {
                            method: 'POST',
                            headers: {
                                'x-session-id': sessionId,
                            },
                            body: formData,
                            signal: controller.signal
                        });
                    } else {
                        res = await fetch('/api/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-session-id': sessionId,
                            },
                            body: JSON.stringify({
                                message: messageText,
                                chatId: currentChatId,
                                model: selectedModel,
                            }),
                            signal: controller.signal
                        });
                    }

                    if (timeoutId) clearTimeout(timeoutId);

                    if (!res.ok) {
                        const errorData = await res.json().catch(() => ({}));
                        throw new Error(errorData.error || 'Fehler beim Senden');
                    }

                    const data = await res.json();
                    const responseText = data.response || 'Keine Antwort erhalten';
                    
                    // WICHTIG: Nachricht erst NACH erfolgreichem Senden hinzuf√ºgen
                    // Die Nachricht wurde bereits im Backend gespeichert, wir m√ºssen sie nur lokal anzeigen
                    addMessage('user', message);

                    // Pr√ºfe, ob die Antwort Code enth√§lt
                    const detectedCode = detectCodeInMessage(responseText);
                    
                    if (detectedCode && (hasCodeRequest || detectedCode.length > 50)) {
                        // Wenn Live-Coding-Indicator noch nicht angezeigt wird, zeige ihn jetzt
                        const existingIndicator = document.getElementById('typingIndicator');
                        if (!existingIndicator || !existingIndicator.querySelector('.live-coding-box')) {
                            removeTypingIndicator();
                            addLiveCodingIndicator();
                        }
                        
                        // Zeige Live-Coding-Animation f√ºr Code - warte bis Animation fertig ist
                        // WICHTIG: Stelle sicher, dass die Animation nicht unterbrochen wird
                        let animationCompleted = false;
                        updateLiveCodingAnimation(detectedCode, () => {
                            if (animationCompleted) return; // Verhindere doppelte Ausf√ºhrung
                            animationCompleted = true;
                            
                            // Animation ist fertig, jetzt die Nachricht hinzuf√ºgen
                            stopLiveCodingAnimation();
                            removeTypingIndicator();
                            stopAssistantTypewriter();
                            
                            // Warte kurz, damit Animation vollst√§ndig abgeschlossen ist
                            setTimeout(() => {
                                addMessage('assistant', responseText);
                                sendBtn.disabled = false;
                                sendBtn.style.opacity = '1';
                                sendBtn.style.pointerEvents = 'auto';
                            }, 200);
                        });
                    } else {
                        // Normale Antwort ohne Code-Animation
                        removeTypingIndicator();
                        stopLiveCodingAnimation();
                        stopAssistantTypewriter();
                        // Warte, bis alle Animationen abgeschlossen sind
                        setTimeout(() => {
                            addMessage('assistant', responseText, { animate: true });
                            sendBtn.disabled = false;
                            sendBtn.style.opacity = '1';
                            sendBtn.style.pointerEvents = 'auto';
                        }, 100);
                    }

                } catch (error) {
                    if (timeoutId) clearTimeout(timeoutId);
                    removeTypingIndicator();
                    stopLiveCodingAnimation();
                    stopAssistantTypewriter();
                    
                    if (error.name === 'AbortError') {
                        addMessage('assistant', '‚ö†Ô∏è Zeit√ºberschreitung: Die Anfrage dauerte zu lange.');
                    } else {
                        addMessage('assistant', '‚ö†Ô∏è Fehler: ' + (error.message || 'Unbekannter Fehler'));
                    }
                    
                    sendBtn.disabled = false;
                    sendBtn.style.opacity = '1';
                    sendBtn.style.pointerEvents = 'auto';
                }
            });
        }

        // FILE UPLOAD
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);

            files.forEach((file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedFiles.push({
                        name: file.name,
                        type: file.type,
                        data: e.target.result,
                    });
                    updateFilePreview();
                };
                reader.readAsDataURL(file);
            });

            event.target.value = '';
        }

        function updateFilePreview() {
            const preview = document.getElementById('filePreview');
            preview.innerHTML = uploadedFiles
                .map(
                    (file, index) => `
                <div class="file-preview-item">
                    <i class="fas ${
                        file.type.startsWith('image/') ? 'fa-image' : 'fa-file'
                    }"></i>
                    <span>${file.name}</span>
                    <button class="file-preview-remove" onclick="removeFile(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `
                )
                .join('');
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFilePreview();
        }

        // ? NEW: Grid View Toggle
        function toggleGridView() {
            isGridView = !isGridView;
            const gridBtn = document.getElementById('gridViewBtn');
            const messages = document.getElementById('chatMessages');
            const inputWrapper = document.getElementById('chatInputWrapper');

            if (isGridView) {
                gridBtn.classList.add('active');
                inputWrapper.style.display = 'none';
                renderGridView();
            } else {
                gridBtn.classList.remove('active');
                inputWrapper.style.display = 'block';
                if (currentChatId) {
                    const chat = chats.find(c => c.id === currentChatId);
                    if (chat) renderMessages(chat.messages);
                }
            }
        }

        function renderGridView() {
            const container = document.getElementById('chatMessages');

            if (chats.length === 0) {
                container.innerHTML = `
                    <div class="welcome-screen">
                        <div class="welcome-title">Keine Chats vorhanden</div>
                        <div class="welcome-subtitle">Erstelle einen neuen Chat, um zu beginnen</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="chat-grid">
                    ${chats
                        .map((chat) => {
                            const lastMessage = chat.messages[chat.messages.length - 1];
                            const preview =
                                lastMessage ? lastMessage.content.substring(0, 100) : 'Keine Nachrichten';
                            const time = new Date(chat.updatedAt).toLocaleDateString('de-DE');

                            return `
                            <div class="chat-grid-item" data-chat-id="${chat.id}">
                                <div class="chat-grid-item-header">
                                    <div class="chat-grid-item-icon">üí¨</div>
                                    <div class="chat-grid-item-title">${escapeHtml(chat.title)}</div>
                                </div>
                                <div class="chat-grid-item-preview">${escapeHtml(preview)}...</div>
                                <div class="chat-grid-item-meta">
                                    <span>${chat.messages.length} Nachrichten</span>
                                    <span>${time}</span>
                                </div>
                            </div>
                        `;
                        })
                        .join('')}
                </div>
            `;
            
            // Add event delegation for grid items
            const gridItems = container.querySelectorAll('.chat-grid-item');
            gridItems.forEach(item => {
                item.addEventListener('click', () => {
                    const chatId = item.getAttribute('data-chat-id');
                    if (chatId) {
                        switchToChatFromGrid(chatId);
                    }
                });
            });
        }

        function switchToChatFromGrid(chatId) {
            isGridView = false;
            document.getElementById('gridViewBtn').classList.remove('active');
            document.getElementById('chatInputWrapper').style.display = 'block';
            switchToChat(chatId);
        }

        // ? NEW: Image Generation
        function openImageGen() {
            openModal('imageGenModal');
        }

        async function generateImage() {
            const prompt = document.getElementById('imagePrompt').value.trim();
            const size = document.getElementById('imageSize').value;
            const model = document.getElementById('imageModel').value;
            const btn = document.getElementById('generateImageBtn');
            const resultDiv = document.getElementById('imageResult');

            if (!prompt) {
                alert('Bitte gib eine Bildbeschreibung ein');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generiere kostenlos...';
            resultDiv.classList.remove('show');

            try {
                const [width, height] = size.split('x').map(Number);

                const res = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-session-id': sessionId,
                    },
                    body: JSON.stringify({ prompt, width, height, model }),
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Fehler bei der Bildgenerierung');
                }

                currentGeneratedImage = data.imageUrl;
                const img = document.getElementById('generatedImage');

                // Zeige Loading-Indikator im Bild
                img.src = '';
                img.style.background =
                    'linear-gradient(45deg, var(--bg-tertiary) 25%, transparent 25%, transparent 75%, var(--bg-tertiary) 75%, var(--bg-tertiary)), linear-gradient(45deg, var(--bg-tertiary) 25%, transparent 25%, transparent 75%, var(--bg-tertiary) 75%, var(--bg-tertiary))';
                img.style.backgroundSize = '20px 20px';
                img.style.backgroundPosition = '0 0, 10px 10px';

                // Lade Bild
                img.onload = function () {
                    img.style.background = 'none';
                    resultDiv.classList.add('show');
                };

                img.src = data.imageUrl;
                document.getElementById('revisedPrompt').textContent = data.revisedPrompt;
            } catch (error) {
                alert('Fehler: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Bild kostenlos generieren';
            }
        }

        function regenerateImage() {
            generateImage();
        }

        function downloadImage() {
            if (!currentGeneratedImage) return;
            window.open(currentGeneratedImage, '_blank');
        }

        function sendImageToChat() {
            if (!currentGeneratedImage) return;
            closeModal('imageGenModal');

            const chat = getCurrentChat();
            if (!chat) return;

            addMessage(
                'assistant',
                `üñºÔ∏è Generiertes Bild:\n\n![Generated Image](${currentGeneratedImage})`
            );
        }

        // ? NEW: Voice-to-Text (Improved)
        async function toggleVoiceInput() {
            if (!isRecording) {
                await startRecording();
            } else {
                await stopRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm',
                });
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await transcribeAudio(audioBlob);
                };

                mediaRecorder.start();
                isRecording = true;
                document.getElementById('voiceBtn').classList.add('recording');
                document.getElementById('voiceBtn').innerHTML = '<i class="fas fa-stop"></i>';
            } catch (error) {
                alert('Mikrofon-Zugriff verweigert');
            }
        }

        async function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach((track) => track.stop());
                isRecording = false;
                document.getElementById('voiceBtn').classList.remove('recording');
                document.getElementById('voiceBtn').innerHTML = '<i class="fas fa-microphone"></i>';
            }
        }

        async function transcribeAudio(audioBlob) {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.webm');

            try {
                const res = await fetch('/api/voice-to-text', {
                    method: 'POST',
                    headers: {
                        'x-session-id': sessionId,
                    },
                    body: formData,
                });

                const data = await res.json();

                if (res.ok) {
                    const input = document.getElementById('chatInput');
                    input.value += (input.value ? ' ' : '') + data.text;
                    input.focus();
                } else {
                    alert('Transkription fehlgeschlagen: ' + data.error);
                }
            } catch (error) {
                alert('Fehler bei der Transkription: ' + error.message);
            }
        }

        // ? NEW: Settings Modal
        async function openSettings() {
            openModal('settingsModal');
            await loadSettings();
        }

        async function loadSettings() {
            const settingsBody = document.getElementById('settingsBody');

            if (currentUser.role === 'admin') {
                // Admin Settings: User Management + Admin Announcement
                settingsBody.innerHTML = `
                    <div class="settings-section">
                        <h3 class="settings-title">üì¢ Admin-Nachricht</h3>
                        <div class="setting-item">
                            <div class="setting-label">Nachricht f√ºr alle Benutzer</div>
                            <div class="setting-description">Diese Nachricht wird oben im Dashboard f√ºr alle Benutzer angezeigt</div>
                            <textarea id="adminAnnouncementText" class="input-field" style="min-height: 100px;" placeholder="z.B. Wichtige Ank√ºndigung: Am Freitag findet keine Schule statt..."></textarea>
                            <div style="display: flex; gap: 8px; margin-top: 12px;">
                                <button class="btn btn-primary" onclick="saveAdminAnnouncement()">
                                    <i class="fas fa-save"></i> Nachricht speichern
                                </button>
                                <button class="btn" onclick="clearAdminAnnouncement()">
                                    <i class="fas fa-trash"></i> Nachricht l√∂schen
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h3 class="settings-title">Benutzerverwaltung</h3>
                        <button class="btn btn-primary" onclick="openCreateUserModal()" style="margin-bottom: 20px;">
                            <i class="fas fa-user-plus"></i> Neuer Benutzer
                        </button>
                        <div class="admin-user-table" id="adminUserTable">
                            <div style="padding: 20px; text-align: center;">
                                <i class="fas fa-spinner fa-spin"></i> Lade Benutzer...
                            </div>
                        </div>
                    </div>`;
                await loadAdminUsers();
                await loadAdminAnnouncementForEdit();
            } else {
                // User Settings: Personal Settings
                const userId = currentUser.userId || currentUser.phone;
                const res = await fetch(
                    `/api/users/${encodeURIComponent(userId)}/settings`,
                    {
                        headers: { 'x-session-id': sessionId },
                    }
                );
                const data = await res.json();
                const settings = data.settings;

                settingsBody.innerHTML = `
                    <div class="settings-section">
                        <h3 class="settings-title">üë§ Profil</h3>
                        <div class="setting-item">
                            <div class="setting-label">Avatar</div>
                            <div class="avatar-preview" id="profileAvatarPreview">
                                <img src="" alt="Avatar" onerror="this.style.display='none';" />
                            </div>
                            <label class="upload-label" style="display:inline-block; width:auto;">
                                Neues Bild w√§hlen
                                <input type="file" id="profileAvatarInput" accept="image/*" onchange="uploadProfileAvatar(event)" />
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">Anzeigename</div>
                            <input type="text" id="profileDisplayName" class="input-field" placeholder="z.B. Lea, Max, Tutor..." />
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">Bio / Status</div>
                            <textarea id="profileBio" class="input-field" placeholder="Beschreibe dich in 200 Zeichen"></textarea>
                        </div>
                        <button class="btn" style="width: 100%;" onclick="saveProfileSettings()">
                            <i class="fas fa-id-card"></i> Profil speichern
                        </button>
                    </div>

                    <div class="settings-section">
                        <h3 class="settings-title">ü§ñ KI-Einstellungen</h3>
                        <div class="setting-item">
                            <div class="setting-label">Eigener System-Prompt</div>
                            <div class="setting-description">Definiere, wie Aeon auf deine Nachrichten antworten soll</div>
                            <textarea id="customPrompt" class="input-field" style="min-height: 120px;" placeholder="z.B. Du bist ein freundlicher Hausaufgaben-Helfer...">${settings.customPrompt || ''}</textarea>
                            <button class="btn" style="margin-top: 8px;" onclick="resetPrompt()">
                                <i class="fas fa-undo"></i> Auf Standard zur√∂cksetzen
                            </button>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">Multi-AI System aktivieren</div>
                            <div class="setting-description">Nutze 3 KI-Generatoren + 2 Validatoren f√∂r bessere Antworten (langsamer, aber genauer)</div>
                            <div class="toggle-switch ${settings.enableMultiAI ? 'active' : ''}" id="enableMultiAI" onclick="toggleSettingSwitch(this)"></div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3 class="settings-title">üì± WhatsApp Bot Einstellungen</h3>
                        <div class="setting-item">
                            <div class="setting-label">Spam-Limit</div>
                            <div class="setting-description">Maximale Anzahl an Nachrichten pro Spam-Befehl (1-100.000)</div>
                            <input type="number" id="spamLimit" class="input-field" value="${settings.spamLimit}" min="1" max="100000" style="max-width: 200px;" />
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">Nur auf Befehle reagieren</div>
                            <div class="setting-description">Bot reagiert nur, wenn Nachricht mit Pr√∂fix beginnt (gilt auch in Gruppen)</div>
                            <div class="toggle-switch ${settings.reactOnCommand ? 'active' : ''}" id="reactOnCommand" onclick="toggleSettingSwitch(this)"></div>
                        </div>
                        <div class="setting-item ${settings.reactOnCommand ? '' : 'hidden'}" id="commandPrefixRow">
                            <div class="setting-label">Befehlspr√∂fix</div>
                            <div class="setting-description">Zeichen, mit dem Befehle beginnen m√∂ssen (z.B. !, /, .)</div>
                            <input type="text" id="commandPrefix" class="input-field" value="${settings.commandPrefix}" maxlength="3" style="max-width: 100px;" />
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">OCR (Texterkennung) aktivieren</div>
                            <div class="setting-description">Texte aus Bildern automatisch erkennen</div>
                            <div class="toggle-switch ${settings.enableOCR !== false ? 'active' : ''}" id="enableOCR" onclick="toggleSettingSwitch(this)"></div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">MEGA Cloud Integration aktivieren</div>
                            <div class="setting-description">Schulbuch-Seiten automatisch abrufen</div>
                            <div class="toggle-switch ${settings.enableMega !== false ? 'active' : ''}" id="enableMega" onclick="toggleSettingSwitch(this)"></div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3 class="settings-title">‚öôÔ∏è Trigger & Automatisierung</h3>
                        <div class="setting-item">
                            <div class="setting-label">Alias / Shortcuts</div>
                            <div class="setting-description">Ein Alias pro Zeile im Format <code>/k√ºrzel =&gt; Ausformulierte Nachricht</code></div>
                            <textarea id="aliasDefinitions" class="input-field" style="min-height: 100px;" placeholder="/hausaufgabe =&gt; Bitte hilf mir bei meinen Hausaufgaben..."></textarea>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">Stichworte f√ºr MEGA Weiterleitung</div>
                            <div class="setting-description">Kommagetrennte Liste (z.B. buch, arbeitsblatt, seite 5)</div>
                            <input type="text" id="megaKeywords" class="input-field" placeholder="buch, arbeitsblatt" />
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">Stichworte f√ºr OCR Verarbeitung</div>
                            <div class="setting-description">Bei Bildern mit diesen Stichworten wird OCR erzwungen.</div>
                            <input type="text" id="ocrKeywords" class="input-field" placeholder="scannen, text erkennen" />
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3 class="settings-title">üß† Multi-KI Einstellungen</h3>
                        <div class="setting-item">
                            <div class="setting-label">Bevorzugte Modell-Reihenfolge</div>
                            <div class="setting-description">Wird f√ºr das Multi-AI Orchester verwendet.</div>
                            <select id="modelPriority" class="input-field" multiple>
                                <option value="deepseek">DeepSeek R1</option>
                                <option value="llama">Llama 4 Scout</option>
                                <option value="gemini">Gemini 2.5</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">Modelle ausschlie√üen</div>
                            <div class="setting-description">Diese Modelle werden in Multi-AI Runs √ºbersprungen.</div>
                            <select id="modelBlacklist" class="input-field" multiple>
                                <option value="deepseek">DeepSeek R1</option>
                                <option value="llama">Llama 4 Scout</option>
                                <option value="gemini">Gemini 2.5</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">Auto-Fallback (schnelle Antwort bei Fehlern)</div>
                            <div class="setting-description">Wenn deaktiviert, wird kein automatischer Wechsel auf ein einfaches Modell durchgef√ºhrt.</div>
                            <div class="toggle-switch active" id="autoFallbackToggle" onclick="toggleSettingSwitch(this)"></div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3 class="settings-title">ü¶æ Barrierefreiheit & UI</h3>
                        <div class="setting-item">
                            <div class="setting-label">Schriftgr√∂√üe</div>
                            <select id="fontSizeSelect" class="input-field" style="max-width: 200px;">
                                <option value="small">Klein</option>
                                <option value="medium" selected>Mittel</option>
                                <option value="large">Gro√ü</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">Kontrastmodus</div>
                            <select id="contrastMode" class="input-field" style="max-width: 200px;">
                                <option value="normal">Standard</option>
                                <option value="high">Hoher Kontrast</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">Automatische Formatierung</div>
                            <div class="setting-description">Bei deaktiviertem Modus werden Unterhaltungen als Plaintext dargestellt.</div>
                            <div class="toggle-switch active" id="autoFormatToggle" onclick="toggleSettingSwitch(this)"></div>
                        </div>
                    </div>

                    <div style="padding: 16px 0; border-top: 1px solid var(--border-color); margin-top: 16px;">
                        <button class="btn btn-primary" onclick="saveUserSettings()" style="width: 100%;">
                            <i class="fas fa-save"></i> Einstellungen speichern
                        </button>
                    </div>
                `;

                userPreferences = ensureClientSettings(settings);
                applyAccessibility(userPreferences.accessibility);
                currentProfile = userPreferences.profile;
                const profile = userPreferences.profile || {};
                const displayInput = document.getElementById('profileDisplayName');
                const bioInput = document.getElementById('profileBio');
                if (displayInput) displayInput.value = profile.displayName || '';
                if (bioInput) bioInput.value = profile.bio || '';
                const avatarPreview = document.querySelector('#profileAvatarPreview img');
                if (avatarPreview) {
                    if (profile.avatarUrl) {
                        avatarPreview.src = profile.avatarUrl;
                        avatarPreview.style.display = 'block';
                    } else {
                        avatarPreview.style.display = 'none';
                    }
                }

                document.getElementById('aliasDefinitions').value = formatAliasList(userPreferences.aliases);
                document.getElementById('megaKeywords').value = userPreferences.keywordRouting.mega.join(', ');
                document.getElementById('ocrKeywords').value = userPreferences.keywordRouting.ocr.join(', ');
                setSelectValues('modelPriority', userPreferences.modelPreferences.priority);
                setSelectValues('modelBlacklist', userPreferences.modelPreferences.blacklist);
                setToggleState('autoFallbackToggle', userPreferences.modelPreferences.autoFallback !== false);
                document.getElementById('fontSizeSelect').value = userPreferences.accessibility.fontSize || 'medium';
                document.getElementById('contrastMode').value = userPreferences.accessibility.highContrast ? 'high' : 'normal';
                setToggleState('autoFormatToggle', userPreferences.accessibility.autoFormat !== false);
            }
        }

        async function loadAdminUsers() {
            try {
                const res = await fetch('/api/users-with-stats', {
                    headers: { 'x-session-id': sessionId },
                });
                const data = await res.json();

                adminUsersCache = new Map();

                const tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>Benutzer</th>
                                <th>Telefon</th>
                                <th>Nachrichten</th>
                                <th>Zuletzt online</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.users
                                .map((user) => {
                                    adminUsersCache.set(user.userId, user);
                                    const lastOnline = new Date(user.lastOnline).toLocaleString('de-DE');
                                    const isOnline = Date.now() - user.lastOnline < 5 * 60 * 1000;
                                    return `
                                    <tr>
                                        <td>
                                            <div style="font-weight:600;">${escapeHtml(user.username)}</div>
                                            <div style="font-size:12px; color:var(--text-secondary);">${user.userId}</div>
                                        </td>
                                        <td>${user.phone || '‚Äì'}</td>
                                        <td>${user.totalMessages}</td>
                                        <td>
                                            <span class="status-badge ${isOnline ? 'status-online' : 'status-offline'}">
                                                ${isOnline ? 'üü¢ Online' : 'üìÖ ' + lastOnline}
                                            </span>
                                        </td>
                                        <td>
                                            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                                <button class="btn" onclick="openManageUserModal('${user.userId}')">
                                                    <i class="fas fa-sliders-h"></i> Verwalten
                                                </button>
                                                <button class="btn btn-danger" onclick="deleteUserProfile('${user.userId}', '${escapeHtml(user.username)}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>`;
                                })
                                .join('')}
                        </tbody>
                    </table>`;
                document.getElementById('adminUserTable').innerHTML = tableHtml;
            } catch (error) {
                document.getElementById('adminUserTable').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                        Fehler beim Laden der Benutzer
                    </div>`;
            }
        }

        function openCreateUserModal() {
            document.getElementById('createUserError').classList.add('hidden');
            document.getElementById('createUserForm').reset();
            openModal('createUserModal');
        }

        async function handleCreateUser(event) {
            event.preventDefault();

            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const phone = document.getElementById('newPhone').value.trim();

            const errorDiv = document.getElementById('createUserError');
            errorDiv.classList.add('hidden');

            try {
                const res = await fetch('/api/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-session-id': sessionId
                    },
                    body: JSON.stringify({
                        username,
                        password,
                        phone: phone || null
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    errorDiv.textContent = data.error || data.message || 'Fehler beim Erstellen';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                alert('Benutzer erfolgreich erstellt!');
                closeModal('createUserModal');
                await loadAdminUsers(); // Refresh user list

            } catch (error) {
                errorDiv.textContent = 'Verbindungsfehler';
                errorDiv.classList.remove('hidden');
            }
        }

        async function openManageUserModal(userId) {
            try {
                const [userRes, settingsRes] = await Promise.all([
                    fetch(`/api/users/${encodeURIComponent(userId)}`, {
                        headers: { 'x-session-id': sessionId }
                    }),
                    fetch(`/api/users/${encodeURIComponent(userId)}/settings`, {
                        headers: { 'x-session-id': sessionId }
                    })
                ]);

                if (!userRes.ok || !settingsRes.ok) {
                    throw new Error('Fehler beim Laden der Benutzerdaten');
                }

                const userData = await userRes.json();
                const settingsData = await settingsRes.json();
                const info = userData.user;
                const settings = ensureClientSettings(settingsData.settings || {});

                managedUserId = userId;
                document.getElementById('manageUserMeta').textContent = `${info.username} ‚Ä¢ ${info.phone || 'keine Nummer'}`;
                document.getElementById('managedCustomPrompt').value = settings.customPrompt || '';
                setToggleState('managedMultiAIToggle', settings.enableMultiAI !== false);
                setToggleState('managedOcrToggle', settings.enableOCR !== false);
                setToggleState('managedMegaToggle', settings.enableMega !== false);

                openModal('manageUserModal');
            } catch (error) {
                alert('Benutzer konnte nicht geladen werden: ' + error.message);
            }
        }

        async function saveManagedUserSettings() {
            if (!managedUserId) return;
            try {
                const payload = {
                    customPrompt: document.getElementById('managedCustomPrompt').value.trim() || null,
                    enableMultiAI: getToggleState('managedMultiAIToggle'),
                    enableOCR: getToggleState('managedOcrToggle'),
                    enableMega: getToggleState('managedMegaToggle')
                };

                const res = await fetch(`/api/users/${encodeURIComponent(managedUserId)}/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-session-id': sessionId
                    },
                    body: JSON.stringify({ settings: payload })
                });

                if (!res.ok) {
                    const data = await res.json().catch(() => ({}));
                    throw new Error(data.error || 'Speichern fehlgeschlagen');
                }

                alert('Einstellungen aktualisiert');
                closeModal('manageUserModal');
                await loadAdminUsers();
            } catch (error) {
                alert('Fehler: ' + error.message);
            }
        }

        async function resetManagedUserPassword() {
            if (!managedUserId) return;
            const newPassword = prompt('Neues Passwort f√ºr diesen Benutzer eingeben (mind. 6 Zeichen):');
            if (!newPassword) return;
            if (newPassword.length < 6) {
                alert('Passwort muss mindestens 6 Zeichen haben.');
                return;
            }

            try {
                const res = await fetch(`/api/users/${encodeURIComponent(managedUserId)}/password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-session-id': sessionId
                    },
                    body: JSON.stringify({ newPassword })
                });

                if (!res.ok) {
                    const data = await res.json().catch(() => ({}));
                    throw new Error(data.error || 'Passwort konnte nicht ge√§ndert werden');
                }

                alert('Passwort aktualisiert');
            } catch (error) {
                alert('Fehler: ' + error.message);
            }
        }

        async function deleteManagedUser(usernameOverride = null) {
            if (!managedUserId) return;
            const username = usernameOverride || adminUsersCache.get(managedUserId)?.username || 'diesen Benutzer';
            if (!confirm(`Benutzer "${username}" wirklich l√∂schen?`)) return;
            try {
                const res = await fetch(`/api/users/${encodeURIComponent(managedUserId)}`, {
                    method: 'DELETE',
                    headers: { 'x-session-id': sessionId }
                });
                if (!res.ok) {
                    const data = await res.json().catch(() => ({}));
                    throw new Error(data.error || 'L√∂schen fehlgeschlagen');
                }
                closeModal('manageUserModal');
                managedUserId = null;
                await loadAdminUsers();
            } catch (error) {
                alert('Fehler: ' + error.message);
            }
        }

        async function deleteUserProfile(userId, username) {
            managedUserId = userId;
            await deleteManagedUser(username);
        }

        async function saveUserSettings() {
            const settings = {
                customPrompt: document.getElementById('customPrompt').value.trim() || null,
                spamLimit: parseInt(document.getElementById('spamLimit').value, 10),
                reactOnCommand: document.getElementById('reactOnCommand').classList.contains('active'),
                commandPrefix: document.getElementById('commandPrefix').value,
                enableMultiAI: document.getElementById('enableMultiAI').classList.contains('active'),
                enableOCR: document.getElementById('enableOCR').classList.contains('active'),
                enableMega: document.getElementById('enableMega').classList.contains('active'),
                aliases: parseAliasInput(document.getElementById('aliasDefinitions').value),
                keywordRouting: {
                    mega: parseKeywordInput(document.getElementById('megaKeywords').value),
                    ocr: parseKeywordInput(document.getElementById('ocrKeywords').value)
                },
                modelPreferences: {
                    priority: getSelectedValues('modelPriority'),
                    blacklist: getSelectedValues('modelBlacklist'),
                    autoFallback: getToggleState('autoFallbackToggle')
                },
                accessibility: {
                    fontSize: document.getElementById('fontSizeSelect').value,
                    highContrast: document.getElementById('contrastMode').value === 'high',
                    autoFormat: getToggleState('autoFormatToggle')
                }
            };

            try {
                const userId = currentUser.userId || currentUser.phone;
                const res = await fetch(
                    `/api/users/${encodeURIComponent(userId)}/settings`,
                    {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-session-id': sessionId,
                        },
                        body: JSON.stringify({ settings }),
                    }
                );

                if (res.ok) {
                    userPreferences = ensureClientSettings(settings);
                    applyAccessibility(userPreferences.accessibility);
                    alert('‚úÖ Einstellungen erfolgreich gespeichert!');
                } else {
                    const data = await res.json();
                    alert('‚ö†Ô∏è Fehler: ' + (data.error || data.message));
                }
            } catch (error) {
                alert('‚ö†Ô∏è Verbindungsfehler');
            }
        }

        // ? IMPROVED: HTML Preview (Fix f√∂r Freeze-Problem)
        function openHtmlPreview(htmlCode) {
            try {
                const modal = document.getElementById('htmlPreviewModal');
                const iframe = document.getElementById('htmlPreviewIframe');

                if (!modal || !iframe) {
                    console.error('HTML Preview Modal nicht gefunden');
                    return;
                }

                // Prevent UI freeze by using requestAnimationFrame
                requestAnimationFrame(() => {
                    modal.classList.add('show');
                    iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms');
                    
                    // Use setTimeout to prevent blocking
                    setTimeout(() => {
                        try {
                            iframe.srcdoc = htmlCode || '';
                        } catch (e) {
                            console.error('Fehler beim Laden des HTML:', e);
                            iframe.srcdoc = '<html><body><p style="padding: 20px; color: red;">Fehler beim Laden der Vorschau</p></body></html>';
                        }
                    }, 10);
                });
            } catch (error) {
                console.error('Fehler in openHtmlPreview:', error);
                alert('Fehler beim √ñffnen der Vorschau');
            }
        }

        function closeHtmlPreview() {
            try {
                const modal = document.getElementById('htmlPreviewModal');
                const iframe = document.getElementById('htmlPreviewIframe');

                if (modal) modal.classList.remove('show');
                if (iframe) {
                    // Clear iframe content asynchronously
                    setTimeout(() => {
                        iframe.srcdoc = '';
                    }, 100);
                }
            } catch (error) {
                console.error('Fehler in closeHtmlPreview:', error);
            }
        }

        // PRESENTATION MODE
        function openPresentation(htmlCode, title = 'Pr√§sentation') {
            try {
                const container = document.getElementById('presentationContainer');
                const iframe = document.getElementById('presentationIframe');
                const titleEl = document.getElementById('presentationTitle');

                if (!container || !iframe) {
                    console.error('Presentation Container nicht gefunden');
                    return;
                }

                if (titleEl) titleEl.textContent = title;
                container.classList.add('active');
                
                requestAnimationFrame(() => {
                    iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-popups');
                    setTimeout(() => {
                        try {
                            iframe.srcdoc = htmlCode || '';
                        } catch (e) {
                            console.error('Fehler beim Laden der Pr√§sentation:', e);
                        }
                    }, 10);
                });
            } catch (error) {
                console.error('Fehler in openPresentation:', error);
            }
        }

        function exitPresentation() {
            try {
                const container = document.getElementById('presentationContainer');
                const iframe = document.getElementById('presentationIframe');

                if (container) container.classList.remove('active');
                if (iframe) {
                    setTimeout(() => {
                        iframe.srcdoc = '';
                    }, 100);
                }
            } catch (error) {
                console.error('Fehler in exitPresentation:', error);
            }
        }

        // Close presentation on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const container = document.getElementById('presentationContainer');
                if (container && container.classList.contains('active')) {
                    exitPresentation();
                }
            }
        });

        // DETECT CODE ARTIFACTS (HTML, JavaScript, Python, CSS, etc.)
        function detectCodeArtifact(text) {
            // Supported languages with preview capability
            const previewLanguages = {
                'html': { pattern: /```(?:html|xml)?\s*([\s\S]*?)```/i, check: (code) => {
                    return code.includes('<!DOCTYPE') || code.includes('<html') || 
                           (code.includes('<head') && code.includes('<body'));
                }},
                'javascript': { pattern: /```(?:javascript|js)?\s*([\s\S]*?)```/i, check: (code) => {
                    // Check for HTML canvas, DOM manipulation, or interactive JS
                    return code.includes('document.') || code.includes('canvas') || 
                           code.includes('addEventListener') || code.includes('onclick');
                }},
                'css': { pattern: /```(?:css)?\s*([\s\S]*?)```/i, check: (code) => {
                    return code.length > 50 && (code.includes('{') && code.includes('}'));
                }}
            };

            // Check for complete HTML document first
            const htmlPattern = /<html[\s\S]*?<\/html>/i;
            const htmlMatch = text.match(htmlPattern);
            if (htmlMatch) {
                return { type: 'html', code: htmlMatch[0] };
            }

            // Check for HTML in code blocks
            if (previewLanguages.html.pattern.test(text)) {
                const match = text.match(previewLanguages.html.pattern);
                if (match && match[1]) {
                    const code = match[1].trim();
                    if (previewLanguages.html.check(code)) {
                        return { type: 'html', code: code };
                    }
                }
            }

            // Check for JavaScript with HTML output capability
            if (previewLanguages.javascript.pattern.test(text)) {
                const match = text.match(previewLanguages.javascript.pattern);
                if (match && match[1]) {
                    const code = match[1].trim();
                    if (previewLanguages.javascript.check(code)) {
                        // Wrap in HTML for preview - escape script tags to avoid parsing issues
                        const escapedCode = code.replace(/<\/script>/gi, '<\\/script>');
                        const htmlWrapper = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>JavaScript Preview</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
    </style>
</head>
<body>
    <div id="output"></div>
    <scr${''}ipt>
        ${escapedCode}
    </scr${''}ipt>
</body>
</html>`;
                        return { type: 'javascript', code: htmlWrapper, originalCode: code };
                    }
                }
            }

            // Check for CSS (wrap in HTML)
            if (previewLanguages.css.pattern.test(text)) {
                const match = text.match(previewLanguages.css.pattern);
                if (match && match[1]) {
                    const code = match[1].trim();
                    if (previewLanguages.css.check(code)) {
                        // Escape style tags to avoid parsing issues
                        const escapedCode = code.replace(/<\/style>/gi, '<\\/style>');
                        const htmlWrapper = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CSS Preview</title>
    <sty${''}le>
        ${escapedCode}
    </sty${''}le>
</head>
<body>
    <div class="preview-container">
        <h1>CSS Preview</h1>
        <p>Dies ist eine Vorschau deines CSS-Codes.</p>
    </div>
</body>
</html>`;
                        return { type: 'css', code: htmlWrapper, originalCode: code };
                    }
                }
            }

            return null;
        }

        // CREATE CODE ARTIFACT (supports multiple languages)
        let artifactCounter = 0;
        function createCodeArtifact(codeData, messageId) {
            artifactCounter++;
            const artifactId = 'artifact_' + messageId + '_' + artifactCounter;
            const { type, code, originalCode } = codeData;
            const displayCode = originalCode || code;
            
            codeBlockStore[artifactId] = code;
            if (originalCode) {
                codeBlockStore[artifactId + '_original'] = originalCode;
            }

            const languageNames = {
                'html': 'HTML',
                'javascript': 'JavaScript',
                'css': 'CSS'
            };

            return `
                <div class="artifact-container" id="${artifactId}">
                    <div class="artifact-header">
                        <div class="artifact-title">
                            <i class="fas fa-code"></i>
                            <span>Interaktives Artefakt - ${languageNames[type] || 'Code'}</span>
                        </div>
                        <div class="artifact-actions">
                            <button class="artifact-btn" onclick="copyArtifactCode('${artifactId}')">
                                <i class="fas fa-copy"></i> Kopieren
                            </button>
                            <button class="artifact-btn" onclick="openArtifactPreview('${artifactId}')">
                                <i class="fas fa-eye"></i> Vorschau
                            </button>
                            <button class="artifact-btn" onclick="openArtifactPresentation('${artifactId}')">
                                <i class="fas fa-presentation"></i> Pr√§sentation
                            </button>
                        </div>
                    </div>
                    <div class="artifact-content">
                        <div class="artifact-editor">
                            <div class="artifact-editor-header">${languageNames[type] || 'Code'}</div>
                            <div class="artifact-editor-content">
                                <textarea id="${artifactId}_editor" oninput="updateArtifactPreview('${artifactId}', '${type}')">${escapeHtml(displayCode)}</textarea>
                            </div>
                        </div>
                        <div class="artifact-splitter" id="${artifactId}_splitter"></div>
                        <div class="artifact-preview">
                            <div class="artifact-preview-header">Live Vorschau</div>
                            <iframe id="${artifactId}_preview" class="artifact-preview-iframe" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
                        </div>
                    </div>
                </div>
            `;
        }

        // ARTIFACT FUNCTIONS
        function copyArtifactCode(artifactId) {
            const code = codeBlockStore[artifactId];
            if (code) {
                navigator.clipboard.writeText(code).then(() => {
                    alert('‚úÖ Code kopiert!');
                }).catch(err => {
                    console.error('Clipboard-Fehler:', err);
                    alert('Fehler beim Kopieren');
                });
            }
        }

        function openArtifactPreview(artifactId) {
            const code = codeBlockStore[artifactId];
            if (code) {
                openHtmlPreview(code);
            }
        }

        function openArtifactPresentation(artifactId) {
            const code = codeBlockStore[artifactId];
            if (code) {
                openPresentation(code, 'HTML Pr√§sentation');
            }
        }

        function updateArtifactPreview(artifactId, type = 'html') {
            const editor = document.getElementById(artifactId + '_editor');
            const preview = document.getElementById(artifactId + '_preview');
            
            if (editor && preview) {
                const code = editor.value;
                
                // Wrap code based on type
                let previewCode = code;
                if (type === 'javascript') {
                    // Escape script tags to avoid parsing issues
                    const escapedCode = code.replace(/<\/script>/gi, '<\\/script>');
                    previewCode = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>JavaScript Preview</title>
    <sty${''}le>
        body { font-family: Arial, sans-serif; padding: 20px; }
    </sty${''}le>
</head>
<body>
    <div id="output"></div>
    <scr${''}ipt>
        ${escapedCode}
    </scr${''}ipt>
</body>
</html>`;
                } else if (type === 'css') {
                    // Escape style tags to avoid parsing issues
                    const escapedCode = code.replace(/<\/style>/gi, '<\\/style>');
                    previewCode = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CSS Preview</title>
    <sty${''}le>
        ${escapedCode}
    </sty${''}le>
</head>
<body>
    <div class="preview-container">
        <h1>CSS Preview</h1>
        <p>Dies ist eine Vorschau deines CSS-Codes.</p>
    </div>
</body>
</html>`;
                }
                
                codeBlockStore[artifactId] = previewCode;
                codeBlockStore[artifactId + '_original'] = code;
                
                // Debounce updates
                clearTimeout(window[artifactId + '_timeout']);
                window[artifactId + '_timeout'] = setTimeout(() => {
                    try {
                        preview.srcdoc = previewCode;
                    } catch (e) {
                        console.error('Fehler beim Aktualisieren der Vorschau:', e);
                    }
                }, 300);
            }
        }

        // Initialize artifact splitter drag
        function initArtifactSplitter(artifactId) {
            const splitter = document.getElementById(artifactId + '_splitter');
            if (!splitter) return;

            let isDragging = false;
            const container = document.getElementById(artifactId);
            if (!container) return;

            splitter.addEventListener('mousedown', (e) => {
                isDragging = true;
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const percentage = (x / rect.width) * 100;
                
                if (percentage > 20 && percentage < 80) {
                    const editor = container.querySelector('.artifact-editor');
                    const preview = container.querySelector('.artifact-preview');
                    
                    if (editor && preview) {
                        editor.style.flex = `0 0 ${percentage}%`;
                        preview.style.flex = `0 0 ${100 - percentage}%`;
                    }
                }
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    document.body.style.cursor = '';
                }
            });
        }

        // MARKDOWN PROCESSING
        function processMarkdown(text) {
            // Check for code artifacts (HTML, JavaScript, CSS, etc.)
            const codeArtifact = detectCodeArtifact(text);
            let processedText = text;
            let artifactHtml = '';

            if (codeArtifact) {
                // Remove code from text and create artifact
                processedText = text.replace(/```(?:html|xml|javascript|js|css)?\s*[\s\S]*?```/i, '');
                processedText = processedText.replace(/<html[\s\S]*?<\/html>/i, '');
                
                const messageId = 'msg_' + Date.now();
                artifactHtml = createCodeArtifact(codeArtifact, messageId);
                
                // Store messageId for initialization
                const initMessageId = messageId;
                const initArtifactId = 'artifact_' + messageId + '_' + artifactCounter;
                
                // Initialize artifact after rendering
                setTimeout(() => {
                    initArtifactSplitter(initArtifactId);
                    // Initialize preview
                    const preview = document.getElementById(initArtifactId + '_preview');
                    if (preview) {
                        preview.srcdoc = codeArtifact.code;
                    }
                }, 100);
            }

            marked.setOptions({
                highlight: function (code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                    }
                    return hljs.highlightAuto(code).value;
                },
                breaks: true,
                gfm: true,
            });

            const renderer = new marked.Renderer();
            const originalCodeRenderer = renderer.code.bind(renderer);

            renderer.code = function (code, language) {
                const lang = language || 'plaintext';
                const highlighted = hljs.highlight(code, { language: lang }).value;

                // ? FIX Bug 2: Speichere Code im Store statt inline
                const codeId = 'code_' + (++codeBlockCounter);
                codeBlockStore[codeId] = code;

                const isHtml = lang === 'html' || lang === 'xml';

                return `
                    <div class="code-block-wrapper">
                        <div class="code-header">
                            <span>${lang}</span>
                            <div class="code-actions">
                                <button class="code-btn" onclick="copyCodeById('${codeId}', this)">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                ${isHtml ? `<button class="code-btn" onclick="openHtmlPreviewById('${codeId}')">
                                    <i class="fas fa-eye"></i> Vorschau
                                </button>` : ''}
                            </div>
                        </div>
                        <pre><code class="language-${lang}">${highlighted}</code></pre>
                    </div>
                `;
            };

            marked.use({ renderer });

            const rawHtml = marked.parse(processedText);
            const cleanHtml = DOMPurify.sanitize(rawHtml);

            // Prepend artifact if exists
            return artifactHtml + cleanHtml;
        }

        // ? FIX Bug 2: Neue Funktion mit Code-Store
        function copyCodeById(codeId, button) {
            const code = codeBlockStore[codeId];
            if (!code) {
                console.error('Code nicht gefunden:', codeId);
                return;
            }

            navigator.clipboard.writeText(code).then(() => {
                const originalHtml = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => {
                    button.innerHTML = originalHtml;
                }, 2000);
            }).catch(err => {
                console.error('Clipboard-Fehler:', err);
                alert('Fehler beim Kopieren');
            });
        }

        // ? FIX Bug 2: Neue Funktion f√∂r HTML-Preview
        function openHtmlPreviewById(codeId) {
            const code = codeBlockStore[codeId];
            if (!code) {
                console.error('Code nicht gefunden:', codeId);
                return;
            }
            openHtmlPreview(code);
        }

        function escapeForTemplate(str) {
            return str
                .replace(/\\/g, '\\\\')
                .replace(/`/g, '\\`')
                .replace(/\$/g, '\\$')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r')
                .replace(/\t/g, '\\t');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // SIDEBAR TOGGLE
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (!sidebar) return;

            if (document.body.classList.contains('sidebar-hidden')) {
                document.body.classList.remove('sidebar-hidden');
                isSidebarPinnedHidden = false;
                updateSidebarToggleBtn();
            }

            sidebar.classList.toggle('collapsed');
            overlay?.classList.toggle('show');
        }

        function toggleSidebarPinned(forceState) {
            if (window.innerWidth <= 1024) {
                toggleSidebar();
                return;
            }
            if (typeof forceState === 'boolean') {
                isSidebarPinnedHidden = forceState;
            } else {
                isSidebarPinnedHidden = !isSidebarPinnedHidden;
            }
            document.body.classList.toggle('sidebar-hidden', isSidebarPinnedHidden);
            updateSidebarToggleBtn();
        }

        function updateSidebarToggleBtn() {
            const btn = document.getElementById('sidebarPinToggle');
            if (!btn) return;
            btn.setAttribute('aria-pressed', isSidebarPinnedHidden ? 'true' : 'false');
            btn.classList.toggle('active', isSidebarPinnedHidden);
            const icon = btn.querySelector('i');
            if (icon) {
                icon.className = isSidebarPinnedHidden ? 'fas fa-bars-staggered' : 'fas fa-columns';
            }
        }

        function toggleChatInputVisibility(forceState) {
            const wrapper = document.getElementById('chatInputWrapper');
            const toggleBtn = document.getElementById('mobileInputToggle');
            const chatInputEl = document.getElementById('chatInput');
            if (!wrapper) return;

            if (typeof forceState === 'boolean') {
                isChatInputCollapsed = forceState;
            } else {
                isChatInputCollapsed = !isChatInputCollapsed;
            }

            wrapper.classList.toggle('collapsed', isChatInputCollapsed);
            if (toggleBtn) {
                toggleBtn.classList.toggle('active', isChatInputCollapsed);
                toggleBtn.setAttribute('aria-pressed', isChatInputCollapsed ? 'true' : 'false');
            }

            if (isChatInputCollapsed && document.activeElement === chatInputEl) {
                chatInputEl.blur();
            } else if (!isChatInputCollapsed && typeof forceState !== 'boolean') {
                chatInputEl?.focus();
            }
        }

        function focusHomeworkInput() {
            switchMainView('home');
            const subjectInput = document.getElementById('homeworkSubject');
            if (subjectInput) {
                subjectInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                subjectInput.focus({ preventScroll: true });
            }
        }

        function initMainNavigation() {
            document.querySelectorAll('.switch-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const view = tab.getAttribute('data-main-view');
                    switchMainView(view);
                });
            });
        }

        function switchMainView(view = 'home') {
            currentMainView = view;
            const homeView = document.getElementById('homeView');
            const chatView = document.getElementById('chatView');

            if (homeView && chatView) {
                homeView.classList.toggle('hidden', view !== 'home');
                chatView.classList.toggle('hidden', view !== 'chat');
            }

            document.querySelectorAll('.switch-tab').forEach(tab => {
                tab.classList.toggle('active', tab.getAttribute('data-main-view') === view);
            });
        }

        function initHomeInteractions() {
            const homeworkForm = document.getElementById('homeworkForm');
            if (homeworkForm) {
                homeworkForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!sessionId) return;
                    const subject = document.getElementById('homeworkSubject').value.trim();
                    const description = document.getElementById('homeworkDescription').value.trim();
                    if (!subject || !description) return;
                    try {
                        const res = await fetch('/api/homework', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-session-id': sessionId
                            },
                            body: JSON.stringify({ subject, description })
                        });
                        const data = await res.json();
                        if (!res.ok) {
                            alert(data.error || 'Hausaufgabe konnte nicht gespeichert werden.');
                            return;
                        }
                        homeworkItems = data.homework || [];
                        renderHomeworkBoard();
                        updateHeroSnapshot();
                        homeworkForm.reset();
                    } catch (error) {
                        alert('Netzwerkfehler: ' + error.message);
                    }
                });
            }

            const materialForm = document.getElementById('materialForm');
            if (materialForm) {
                materialForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!sessionId) return;
                    const fileInput = document.getElementById('materialFile');
                    const title = document.getElementById('materialTitle').value.trim();
                    if (!title) {
                        alert('Bitte einen Titel eingeben.');
                        return;
                    }
                    const formData = new FormData();
                    formData.append('title', title);
                    formData.append('subject', document.getElementById('materialSubject').value.trim());
                    formData.append('description', document.getElementById('materialDescription').value.trim());
                    if (fileInput.files && fileInput.files.length > 0) {
                        formData.append('file', fileInput.files[0]);
                    }

                    try {
                        const res = await fetch('/api/materials', {
                            method: 'POST',
                            headers: { 'x-session-id': sessionId },
                            body: formData
                        });
                        const data = await res.json();
                        if (!res.ok) {
                            alert(data.error || 'Upload fehlgeschlagen');
                            return;
                        }
                        if (data.material) {
                            materialItems = [data.material, ...materialItems];
                            materialMap.set(data.material.id, data.material);
                            renderMaterialsGrid();
                            updateHeroSnapshot();
                            materialForm.reset();
                        } else {
                            loadMaterialsGallery();
                        }
                    } catch (error) {
                        alert('Netzwerkfehler: ' + error.message);
                    }
                });
            }
        }

        async function loadHomeworkBoard() {
            if (!sessionId) return;
            try {
                const res = await fetch('/api/homework', {
                    headers: { 'x-session-id': sessionId }
                });
                const data = await res.json();
                if (res.ok) {
                    homeworkItems = data.homework || [];
                    renderHomeworkBoard();
                    updateHeroSnapshot();
                }
            } catch (error) {
                console.error('Homework Load Error:', error);
            }
        }

        function renderHomeworkBoard() {
            const list = document.getElementById('homeworkList');
            if (!list) return;
            if (!homeworkItems.length) {
                list.innerHTML = '<div class="empty-state">Noch keine Hausaufgaben vorhanden.</div>';
                return;
            }
            list.innerHTML = homeworkItems.map(entry => {
                const canDelete = canManageHomework(entry.user_id);
                const ownerName = getHomeworkOwner(entry);
                return `
                    <div class="homework-card animate-fade-in" data-id="${entry.id}">
                        <div class="homework-card-header">
                            <div>
                                <h4>${escapeHtml(entry.subject)}</h4>
                                <p>${escapeHtml(entry.description)}</p>
                            </div>
                            ${canDelete ? `
                                <button class="icon-button" onclick="deleteHomeworkItem(${entry.id})" title="Eintrag l√∂schen">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            ` : ''}
                        </div>
                        <div class="homework-meta">
                            <span>${formatRelativeTime(entry.created_at)}</span>
                            <span>${escapeHtml(ownerName)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function canManageHomework(ownerId) {
            if (!currentUser) return false;
            if (currentUser.role === 'admin') return true;
            return (currentUser.userId && currentUser.userId === ownerId) || (currentUser.userId && ownerId && currentUser.userId.toString() === ownerId.toString());
        }

        function getHomeworkOwner(entry) {
            const profileName = entry.profile?.displayName?.trim();
            if (profileName) return profileName;
            if (entry.username) return entry.username;
            return 'Unbekannt';
        }

        async function loadMaterialsGallery() {
            if (!sessionId) return;
            try {
                const res = await fetch('/api/materials', {
                    headers: { 'x-session-id': sessionId }
                });
                const data = await res.json();
                if (res.ok) {
                    materialItems = data.materials || [];
                    materialMap = new Map(materialItems.map(item => [item.id, item]));
                    renderMaterialsGrid();
                    updateHeroSnapshot();
                }
            } catch (error) {
                console.error('Material Load Error:', error);
            }
        }

        function renderMaterialsGrid() {
            const grid = document.getElementById('materialsGrid');
            if (!grid) return;
            if (!materialItems.length) {
                grid.innerHTML = '<div class="empty-state">Noch kein Material hochgeladen.</div>';
                return;
            }
            grid.innerHTML = materialItems.map(material => {
                const isImage = material.fileType?.startsWith('image/');
                const thumb = isImage
                    ? `<img src="${material.fileUrl}" alt="${escapeHtml(material.title)}" />`
                    : `<i class="fas fa-file-alt"></i>`;
                const canDelete = canManageMaterial(material);
                return `
                    <div class="material-card" onclick="openMaterialModal(${material.id})" data-id="${material.id}">
                        ${canDelete ? `
                            <button class="card-action-btn" onclick="deleteMaterialItem(${material.id}, event)" title="Material l√∂schen">
                                <i class="fas fa-trash-alt"></i>
                            </button>` : ''}
                        <div class="material-thumb">${thumb}</div>
                        <div class="material-info">
                            <h4>${escapeHtml(material.title)}</h4>
                            <span>${material.subject ? escapeHtml(material.subject) : 'Allgemein'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function canManageMaterial(material) {
            if (!currentUser) return false;
            if (currentUser.role === 'admin') return true;
            const ownerId = material?.uploader?.userId || material?.user_id;
            return ownerId && currentUser.userId && ownerId.toString() === currentUser.userId.toString();
        }

        function updateHeroSnapshot() {
            const homeworkEl = document.getElementById('heroHomeworkCount');
            const materialEl = document.getElementById('heroMaterialCount');
            if (homeworkEl) {
                const count = Array.isArray(homeworkItems) ? homeworkItems.length : 0;
                homeworkEl.textContent = count;
            }
            if (materialEl) {
                const count = Array.isArray(materialItems) ? materialItems.length : 0;
                materialEl.textContent = count;
            }
        }

        async function openMaterialModal(id) {
            if (!materialMap.has(id)) {
                try {
                    const res = await fetch(`/api/materials/${id}`, {
                        headers: { 'x-session-id': sessionId }
                    });
                    const data = await res.json();
                    if (res.ok && data.material) {
                        materialMap.set(data.material.id, data.material);
                    }
                } catch (error) {
                    alert('Material konnte nicht geladen werden.');
                    return;
                }
            }
            const material = materialMap.get(id);
            if (!material) return;
            document.getElementById('materialModalTitle').textContent = material.title;
            const preview = document.getElementById('materialModalPreview');
            const isImage = material.fileType?.startsWith('image/');
            preview.innerHTML = isImage
                ? `<img src="${material.fileUrl}" alt="${escapeHtml(material.title)}" />`
                : `<div class="material-thumb" style="height:220px;"><i class="fas fa-file-download" style="font-size:48px;"></i></div>`;
            document.getElementById('materialModalDescription').textContent = material.description || 'Keine Beschreibung';
            document.getElementById('materialModalSubject').textContent = material.subject || 'Allgemein';
            const avatar = document.getElementById('materialModalAvatar');
            const uploaderName = material.uploader?.profile?.displayName || material.uploader?.username || 'Uploader';
            document.getElementById('materialModalUploader').textContent = uploaderName;

            if (material.uploader?.profile?.avatarUrl) {
                avatar.innerHTML = `<img src="${material.uploader.profile.avatarUrl}" alt="${uploaderName}" />`;
            } else {
                avatar.textContent = uploaderName.charAt(0).toUpperCase();
            }

            const downloadBtn = document.getElementById('materialModalDownload');
            downloadBtn.href = material.fileUrl;
            openModal('materialModal');
        }

        async function deleteHomeworkItem(id) {
            if (!sessionId) return;
            if (!confirm('Eintrag wirklich l√∂schen?')) return;
            SoundSystem.playDelete();
            try {
                const res = await fetch(`/api/homework/${id}`, {
                    method: 'DELETE',
                    headers: { 'x-session-id': sessionId }
                });
                const data = await res.json();
                if (!res.ok) {
                    alert(data.error || 'Eintrag konnte nicht gel√∂scht werden.');
                    return;
                }
                homeworkItems = data.homework || [];
                renderHomeworkBoard();
                updateHeroSnapshot();
            } catch (error) {
                alert('L√∂schen fehlgeschlagen: ' + error.message);
            }
        }

        async function deleteMaterialItem(id, event) {
            event?.stopPropagation();
            if (!sessionId) return;
            if (!confirm('Material wirklich l√∂schen?')) return;
            SoundSystem.playDelete();
            try {
                const res = await fetch(`/api/materials/${id}`, {
                    method: 'DELETE',
                    headers: { 'x-session-id': sessionId }
                });
                const data = await res.json();
                if (!res.ok) {
                    alert(data.error || 'Material konnte nicht gel√∂scht werden.');
                    return;
                }
                materialItems = data.materials || [];
                materialMap = new Map(materialItems.map(item => [item.id, item]));
                renderMaterialsGrid();
                updateHeroSnapshot();
            } catch (error) {
                alert('L√∂schen fehlgeschlagen: ' + error.message);
            }
        }

        function formatRelativeTime(timestamp) {
            if (!timestamp) return '';
            const diff = Date.now() - timestamp;
            const minutes = Math.floor(diff / 60000);
            if (minutes < 1) return 'Jetzt';
            if (minutes < 60) return `${minutes}m`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h`;
            const days = Math.floor(hours / 24);
            return `${days}d`;
        }

        async function fetchOwnProfile() {
            if (!sessionId || !currentUser?.userId) return;
            try {
                const res = await fetch('/api/profile', {
                    headers: { 'x-session-id': sessionId }
                });
                if (res.ok) {
                    const data = await res.json();
                    currentProfile = data.profile;
                    updateSidebarAvatar(currentProfile?.avatarUrl);
                }
            } catch (error) {
                console.error('Profil konnte nicht geladen werden:', error);
            }
        }

        function getCurriculumStorageKey() {
            return currentUser
                ? `${CURRICULUM_STORAGE_PREFIX}${currentUser.username}`
                : `${CURRICULUM_STORAGE_PREFIX}default`;
        }

        function saveCurriculumSelection(state, grade) {
            try {
                localStorage.setItem(getCurriculumStorageKey(), JSON.stringify({ state, grade }));
            } catch (error) {
                console.warn('Curriculum Auswahl konnte nicht gespeichert werden:', error);
            }
        }

        function loadCurriculumSelectionFromStorage() {
            try {
                const raw = localStorage.getItem(getCurriculumStorageKey());
                return raw ? JSON.parse(raw) : null;
            } catch (error) {
                console.warn('Curriculum Auswahl konnte nicht gelesen werden:', error);
                return null;
            }
        }

        async function initializeCurriculumPlanner(forceMeta = false) {
            if (!sessionId) return;
            const stateSelect = document.getElementById('curriculumState');
            const gradeSelect = document.getElementById('curriculumGrade');
            if (!stateSelect || !gradeSelect) return;

            if (!curriculumMeta.states.length || !curriculumMeta.grades.length || forceMeta) {
                try {
                    await loadCurriculumMeta();
                } catch (error) {
                    renderCurriculumError(error.message || 'Curriculum konnte nicht geladen werden.');
                    return;
                }
            } else {
                populateCurriculumFilters();
            }

            const storedSelection = loadCurriculumSelectionFromStorage();
            const defaultState = storedSelection?.state || curriculumMeta.states[0]?.id || '';
            if (defaultState) stateSelect.value = defaultState;
            renderGradeOptionsForState(defaultState, storedSelection?.grade || '');
            const defaultGrade = gradeSelect.value || storedSelection?.grade || '';

            if (!curriculumInitialized) {
                stateSelect.addEventListener('change', () => {
                    const newState = stateSelect.value;
                    renderGradeOptionsForState(newState, gradeSelect.value);
                    handleCurriculumFilterChange();
                });
                gradeSelect.addEventListener('change', handleCurriculumFilterChange);
                document.getElementById('curriculumRefreshBtn')?.addEventListener('click', handleCurriculumFilterChange);
                curriculumInitialized = true;
            }

            if (defaultState && defaultGrade) {
                await loadCurriculumTopics(defaultState, defaultGrade);
            } else {
                renderCurriculumEmptyState();
            }
        }

        async function loadCurriculumMeta() {
            if (!sessionId) {
                throw new Error('Nicht angemeldet');
            }
            const res = await fetch('/api/curriculum', {
                headers: { 'x-session-id': sessionId }
            });
            const data = await res.json();
            if (!res.ok) {
                throw new Error(data.error || 'Curriculum-Metadaten konnten nicht geladen werden.');
            }
            curriculumMeta.states = data.states || [];
            curriculumMeta.grades = data.grades || [];
            curriculumMeta.stateGradeMap = data.stateGradeMap || {};
            populateCurriculumFilters();
            return data;
        }

        function populateCurriculumFilters() {
            const stateSelect = document.getElementById('curriculumState');
            if (stateSelect) {
                stateSelect.innerHTML = curriculumMeta.states.length
                    ? curriculumMeta.states.map(state => `<option value="${state.id}">${escapeHtml(state.label)}</option>`).join('')
                    : '<option value="">Keine Bundesl√§nder verf√ºgbar</option>';
            }
        }

        function getGradesForState(stateId) {
            if (!stateId) return curriculumMeta.grades || [];
            const allowed = curriculumMeta.stateGradeMap?.[stateId];
            if (Array.isArray(allowed) && allowed.length) {
                return (curriculumMeta.grades || []).filter(grade => allowed.includes(grade.id));
            }
            return curriculumMeta.grades || [];
        }

        function renderGradeOptionsForState(stateId, preferredGrade) {
            const gradeSelect = document.getElementById('curriculumGrade');
            if (!gradeSelect) return;
            const gradeOptions = getGradesForState(stateId);
            gradeSelect.innerHTML = gradeOptions.length
                ? gradeOptions.map(grade => `<option value="${grade.id}">${escapeHtml(grade.label)}</option>`).join('')
                : '<option value="">Keine Klassen verf√ºgbar</option>';

            if (preferredGrade && gradeOptions.some(option => option.id === preferredGrade)) {
                gradeSelect.value = preferredGrade;
            } else if (gradeOptions.length) {
                gradeSelect.value = gradeOptions[0].id;
            } else {
                gradeSelect.value = '';
            }
        }

        function handleCurriculumFilterChange() {
            const stateSelect = document.getElementById('curriculumState');
            const gradeSelect = document.getElementById('curriculumGrade');
            const state = stateSelect?.value;
            let grade = gradeSelect?.value;
            const validGrades = getGradesForState(state);
            if (state && validGrades.length && !validGrades.some(option => option.id === grade)) {
                grade = validGrades[0]?.id || '';
                if (gradeSelect) gradeSelect.value = grade;
            }
            if (!state || !grade) {
                renderCurriculumEmptyState('Bitte Auswahl treffen.');
                return;
            }
            saveCurriculumSelection(state, grade);
            loadCurriculumTopics(state, grade);
        }

        async function loadCurriculumTopics(state, grade) {
            if (!sessionId) return;
            setCurriculumLoading(true, `Lade Themen f√ºr ${state}...`);
            try {
                const query = new URLSearchParams({ state, grade }).toString();
                const res = await fetch(`/api/curriculum?${query}`, {
                    headers: { 'x-session-id': sessionId }
                });
                const data = await res.json();
                if (!res.ok) {
                    renderCurriculumError(data.error || 'Keine Themen gefunden.');
                    return;
                }
                curriculumSelection = data.selection || { state: { id: state }, grade: { id: grade } };
                curriculumSubjects = Array.isArray(data.subjects) ? data.subjects : [];
                updateCurriculumMeta({
                    selection: curriculumSelection,
                    summary: data.summary,
                    lastUpdated: data.lastUpdated,
                    source: data.source
                });
                renderCurriculumSubjects(curriculumSubjects);
            } catch (error) {
                renderCurriculumError('Curriculum konnte nicht geladen werden: ' + error.message);
            } finally {
                setCurriculumLoading(false);
            }
        }

        function renderCurriculumSubjects(subjects = []) {
            const container = document.getElementById('curriculumContent');
            if (!container) return;
            if (!subjects.length) {
                container.innerHTML = '<div class="empty-state">F√ºr diese Auswahl liegen noch keine Themen vor.</div>';
                return;
            }
            container.innerHTML = subjects.map(subject => createCurriculumSubjectMarkup(subject)).join('');
        }

        function createCurriculumSubjectMarkup(subject) {
            const focus = (subject.focus || [])
                .map(item => `<span class="curriculum-chip">${escapeHtml(item)}</span>`)
                .join('');
            const topics = (subject.topics || [])
                .map(topic => createCurriculumTopicMarkup(topic))
                .join('');
            return `
                <div class="curriculum-subject">
                    <div class="curriculum-subject-header">
                        <div>
                            <h4>${escapeHtml(subject.name || 'Fach')}</h4>
                            ${subject.summary ? `<p style="color: var(--text-secondary); font-size: 13px;">${escapeHtml(subject.summary)}</p>` : ''}
                            ${focus ? `<div class="curriculum-focus">${focus}</div>` : ''}
                        </div>
                        <span class="curriculum-topic-count">${subject.topics?.length || 0} Themen</span>
                    </div>
                    <div class="curriculum-topic-list">${topics}</div>
                </div>
            `;
        }

        function createCurriculumTopicMarkup(topic) {
            const competencies = (topic.competencies || [])
                .map(item => `<span class="curriculum-competency">${escapeHtml(item)}</span>`)
                .join('');
            const resources = (topic.resources || [])
                .map(resource => {
                    if (!resource?.url) return '';
                    const meta = getCurriculumResourceMeta(resource.type);
                    const safeUrl = encodeURI(resource.url);
                    return `
                        <a class="curriculum-resource" href="${safeUrl}" target="_blank" rel="noopener">
                            <span class="curriculum-resource-type"><i class="fas ${meta.icon}"></i>${meta.label}</span>
                            <span>${escapeHtml(resource.label || 'Ressource')}</span>
                            <i class="fas fa-external-link-alt" style="font-size: 12px;"></i>
                        </a>
                    `;
                })
                .join('');
            return `
                <div class="curriculum-topic-card">
                    <div class="curriculum-topic-title">${escapeHtml(topic.title || 'Thema')}</div>
                    <p>${escapeHtml(topic.description || '')}</p>
                    ${competencies ? `<div class="curriculum-competencies">${competencies}</div>` : ''}
                    ${resources ? `<div class="curriculum-resources">${resources}</div>` : ''}
                </div>
            `;
        }

        function renderCurriculumEmptyState(message = 'Such dir Bundesland und Klasse aus, dann zeigen wir dir passende Themen.') {
            updateCurriculumMeta({ message });
            const container = document.getElementById('curriculumContent');
            if (!container) return;
            container.innerHTML = `<div class="empty-state">${escapeHtml(message)}</div>`;
        }

        function renderCurriculumError(message) {
            const container = document.getElementById('curriculumContent');
            if (container) {
                container.innerHTML = `<div class="empty-state curriculum-error">${escapeHtml(message)}</div>`;
            }
            updateCurriculumMeta({ message });
        }

        function setCurriculumLoading(isLoading, message = 'Lade Themen...') {
            const container = document.getElementById('curriculumContent');
            if (!container) return;
            if (isLoading) {
                container.innerHTML = `
                    <div class="curriculum-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>${escapeHtml(message)}</span>
                    </div>
                `;
            }
        }

        function updateCurriculumMeta({ selection, summary, lastUpdated, source, message } = {}) {
            const metaEl = document.getElementById('curriculumMeta');
            if (!metaEl) return;
            if (message) {
                metaEl.innerHTML = `<p>${escapeHtml(message)}</p>`;
                return;
            }
            const details = [];
            if (selection?.state && selection?.grade) {
                details.push(`<strong>${escapeHtml(selection.state.label)}</strong> ¬∑ ${escapeHtml(selection.grade.label)}`);
            }
            if (lastUpdated) {
                details.push(`Stand ${formatCurriculumDate(lastUpdated)}`);
            }
            const sourceLink = source ? `<a href="${encodeURI(source)}" target="_blank" rel="noopener">Quelle √∂ffnen</a>` : '';
            metaEl.innerHTML = `
                ${details.length ? `<div>${details.join(' | ')}</div>` : ''}
                ${summary ? `<p>${escapeHtml(summary)}</p>` : ''}
                ${sourceLink}
            `;
        }

        function formatCurriculumDate(value) {
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return value;
            }
            return date.toLocaleDateString('de-DE', { month: '2-digit', year: 'numeric' });
        }

        function getCurriculumResourceMeta(type = 'material') {
            const map = {
                material: { icon: 'fa-file-alt', label: 'Material' },
                video: { icon: 'fa-play', label: 'Video' },
                tutorial: { icon: 'fa-graduation-cap', label: 'Tutorial' },
                article: { icon: 'fa-newspaper', label: 'Artikel' }
            };
            return map[type] || map.material;
        }

        function updateSidebarAvatar(avatarUrl) {
            const avatar = document.getElementById('userAvatar');
            if (!avatar) return;
            if (avatarUrl) {
                avatar.style.backgroundImage = `url('${avatarUrl}')`;
                avatar.style.backgroundSize = 'cover';
                avatar.style.backgroundPosition = 'center';
                avatar.textContent = '';
            } else {
                avatar.style.backgroundImage = '';
                if (currentUser?.username) {
                    avatar.textContent = currentUser.username.charAt(0).toUpperCase();
                }
            }
            const preview = document.querySelector('#profileAvatarPreview img');
            if (preview) {
                if (avatarUrl) {
                    preview.src = avatarUrl;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            }
        }

        async function saveProfileSettings() {
            if (!sessionId) return;
            const displayName = document.getElementById('profileDisplayName')?.value || '';
            const bio = document.getElementById('profileBio')?.value || '';
            try {
                const res = await fetch('/api/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-session-id': sessionId
                    },
                    body: JSON.stringify({ displayName, bio })
                });
                const data = await res.json();
                if (!res.ok) {
                    alert(data.error || 'Profil konnte nicht gespeichert werden');
                    return;
                }
                currentProfile = data.profile;
                updateSidebarAvatar(currentProfile?.avatarUrl);
                alert('Profil gespeichert');
            } catch (error) {
                alert('Netzwerkfehler: ' + error.message);
            }
        }

        async function uploadProfileAvatar(event) {
            if (!sessionId || !event.target.files?.length) return;
            const formData = new FormData();
            formData.append('avatar', event.target.files[0]);
            try {
                const res = await fetch('/api/profile/avatar', {
                    method: 'POST',
                    headers: { 'x-session-id': sessionId },
                    body: formData
                });
                const data = await res.json();
                if (!res.ok) {
                    alert(data.error || 'Avatar konnte nicht gespeichert werden');
                    return;
                }
                currentProfile = data.profile;
                updateSidebarAvatar(data.avatarUrl);
                alert('Avatar aktualisiert');
            } catch (error) {
                alert('Upload fehlgeschlagen: ' + error.message);
            }
        }

        function handleResponsiveLayout() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (sidebar) {
                if (window.innerWidth <= 1024) {
                    sidebar.classList.add('collapsed');
                    overlay?.classList.remove('show');
                    if (isSidebarPinnedHidden) {
                        isSidebarPinnedHidden = false;
                        document.body.classList.remove('sidebar-hidden');
                        updateSidebarToggleBtn();
                    }
                } else {
                    sidebar.classList.remove('collapsed');
                    overlay?.classList.remove('show');
                }
            }
            updateSidebarToggleBtn();

            if (window.innerWidth > 768) {
                toggleChatInputVisibility(false);
            }
        }

        // AUTO-RESIZE TEXTAREA
        const chatInput = document.getElementById('chatInput');
        if (chatInput) {
            chatInput.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            });

            chatInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            chatInput.addEventListener('focus', function () {
                if (isChatInputCollapsed) {
                    toggleChatInputVisibility(false);
                }
            });
        }

        // UTILITY FUNCTIONS
        function scrollToBottom() {
            const messages = document.getElementById('chatMessages');
            if (messages) {
                messages.scrollTop = messages.scrollHeight;
            }
        }

        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.remove('hidden');
            setTimeout(() => {
                el.classList.add('hidden');
            }, 5000);
        }

        function toggleUserMenu() {
            if (confirm('M√∂chtest du dich abmelden?')) {
                logout();
            }
        }

        async function logout() {
            await fetch('/api/logout', {
                method: 'POST',
                headers: { 'x-session-id': sessionId },
            });

            // Stoppe Polling beim Logout
            stopPublicChatPolling();

            // Alle Eingabefelder leeren beim Logout
            clearAllInputFields();

            localStorage.removeItem('sessionId');
            sessionId = null;
            currentUser = null;
            chats = [];
            userPreferences = { accessibility: { ...ACCESSIBILITY_DEFAULTS } };
            applyAccessibility(userPreferences.accessibility);
            showLogin();
        }

        // Modal helpers
        function openModal(id) {
            document.getElementById(id).classList.add('show');
        }
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // Settings helpers
        // Toggle for reactOnCommand (shows/hides prefix input)
        function toggleReactOnCommand(el) {
            el.classList.toggle('active');
            const prefixRow = document.getElementById('commandPrefixRow');
            if (el.classList.contains('active')) {
                prefixRow.classList.remove('hidden');
            } else {
                prefixRow.classList.add('hidden');
            }
        }

        // Generic toggle for other switches
        function toggleSettingSwitch(el) {
            el.classList.toggle('active');
        }

        // Reset prompt to default and save
        async function resetPrompt() {
            if (!confirm('Prompt wirklich auf Standard zur√∂cksetzen?')) return;

            document.getElementById('customPrompt').value = '';

            // ? Sofort speichern
            try {
                const userId = currentUser.userId || currentUser.phone;
                const res = await fetch(
                    `/api/users/${encodeURIComponent(userId)}/reset-prompt`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-session-id': sessionId
                        }
                    }
                );

                if (res.ok) {
                    alert('? Prompt erfolgreich zur√∂ckgesetzt!');
                } else {
                    const data = await res.json();
                    alert('? Fehler: ' + (data.error || data.message));
                }
            } catch (error) {
                alert('? Verbindungsfehler');
            }
        }

        // PUBLIC CHAT FUNCTIONALITY
        async function sendPublicMessage() {
            const input = document.getElementById('publicChatInput');
            const message = input.value.trim();
            if ((!message && publicChatFiles.length === 0) || !sessionId) return;
            
            SoundSystem.playSend();
            
            try {
                const formData = new FormData();
                formData.append('message', message || '');
                
                // Add files if any
                for (const file of publicChatFiles) {
                    const blob = await fetch(file.data).then(r => r.blob());
                    formData.append('files', blob, file.name);
                }
                
                const res = await fetch('/api/public-chat', {
                    method: 'POST',
                    headers: { 'x-session-id': sessionId },
                    body: formData
                });
                
                if (res.ok) {
                    input.value = '';
                    publicChatFiles = [];
                    updatePublicChatFilePreview();
                    clearPublicChatDraft(); // Entwurf nach erfolgreichem Senden l√∂schen
                    loadPublicChat();
                } else {
                    const data = await res.json();
                    alert('Fehler beim Senden: ' + (data.error || 'Unbekannter Fehler'));
                    SoundSystem.playError();
                }
            } catch (error) {
                alert('Fehler: ' + error.message);
                SoundSystem.playError();
            }
        }
        
        async function loadPublicChat() {
            if (!sessionId) return;
            try {
                const res = await fetch('/api/public-chat', {
                    headers: { 'x-session-id': sessionId }
                });
                const data = await res.json();
                if (res.ok && data.messages) {
                    renderPublicChat(data.messages);
                }
                // Entwurf nach dem Laden wiederherstellen
                loadPublicChatDraft();
            } catch (error) {
                console.error('Public chat load error:', error);
            }
        }
        
        function startPublicChatPolling() {
            // Stoppe vorhandenes Polling falls vorhanden
            stopPublicChatPolling();
            
            // Starte neues Polling
            publicChatPollingInterval = setInterval(() => {
                if (sessionId && currentUser) {
                    loadPublicChat();
                }
            }, PUBLIC_CHAT_POLL_INTERVAL);
        }
        
        function stopPublicChatPolling() {
            if (publicChatPollingInterval) {
                clearInterval(publicChatPollingInterval);
                publicChatPollingInterval = null;
            }
        }
        
        function renderPublicChat(messages) {
            const container = document.getElementById('publicChatMessages');
            if (!container) return;
            
            if (!messages || messages.length === 0) {
                container.innerHTML = '<div class="empty-state">Noch keine Nachrichten. Starte die Unterhaltung!</div>';
                return;
            }
            
            container.innerHTML = messages.map(msg => {
                const time = new Date(msg.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                const hasFile = msg.fileUrl || msg.fileName;
                const isOwnMessage = currentUser && msg.user_id === currentUser.userId;
                const deleteButton = isOwnMessage ? `
                    <button onclick="deletePublicChatMessage(${msg.id})" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px 8px; border-radius: 4px; opacity: 0.7; transition: all 0.2s;" 
                            onmouseover="this.style.opacity='1'; this.style.color='var(--error-color, #ef4444)';" 
                            onmouseout="this.style.opacity='0.7'; this.style.color='var(--text-secondary)';" 
                            title="Nachricht l√∂schen">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : '';
                
                // Profilbild oder Initial
                const avatarHtml = msg.avatarUrl 
                    ? `<img src="${escapeHtml(msg.avatarUrl)}" alt="${escapeHtml(msg.username || '')}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color);" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />`
                    : '';
                const avatarInitial = `<div style="width: 32px; height: 32px; border-radius: 50%; background: var(--accent-color); color: white; display: ${msg.avatarUrl ? 'none' : 'flex'}; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; border: 2px solid var(--border-color);">${(msg.username || 'U').charAt(0).toUpperCase()}</div>`;
                
                return `
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color); position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                ${avatarHtml}
                                ${avatarInitial}
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 2px;">
                                        <strong>${escapeHtml(msg.username || 'Unbekannt')}</strong>
                                        <span style="font-size: 12px; color: var(--text-secondary);">${time}</span>
                                    </div>
                                </div>
                            </div>
                            ${deleteButton}
                        </div>
                        ${msg.message ? `<div style="margin-left: 42px; margin-bottom: 8px;">${escapeHtml(msg.message)}</div>` : ''}
                        ${hasFile ? `
                            <div style="margin-left: 42px; margin-top: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 6px;">
                                <i class="fas ${msg.fileType?.startsWith('image/') ? 'fa-image' : 'fa-file'}"></i>
                                ${msg.fileUrl ? `<a href="${escapeHtml(msg.fileUrl)}" target="_blank" style="margin-left: 8px; color: var(--accent-color);">${escapeHtml(msg.fileName || 'Datei')}</a>` : escapeHtml(msg.fileName || 'Datei')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            const chatContainer = document.getElementById('publicChatContainer');
            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        async function deletePublicChatMessage(messageId) {
            if (!confirm('Nachricht wirklich l√∂schen?')) {
                return;
            }

            if (!sessionId) {
                alert('Nicht angemeldet');
                return;
            }

            try {
                const res = await fetch(`/api/public-chat/${messageId}`, {
                    method: 'DELETE',
                    headers: { 'x-session-id': sessionId }
                });

                if (res.ok) {
                    SoundSystem.playDelete();
                    loadPublicChat();
                } else {
                    const data = await res.json();
                    alert('Fehler beim L√∂schen: ' + (data.error || 'Unbekannter Fehler'));
                    SoundSystem.playError();
                }
            } catch (error) {
                alert('Fehler: ' + error.message);
                SoundSystem.playError();
            }
        }
        
        // Material file preview
        function handleMaterialFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                clearMaterialFile();
                return;
            }
            
            const preview = document.getElementById('materialFilePreview');
            const nameEl = document.getElementById('materialPreviewName');
            const sizeEl = document.getElementById('materialPreviewSize');
            
            if (preview && nameEl && sizeEl) {
                nameEl.textContent = file.name;
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                sizeEl.textContent = `${sizeMB} MB ‚Ä¢ ${file.type || 'Unbekannter Typ'}`;
                preview.style.display = 'block';
                SoundSystem.playFileAttach();
            }
        }
        
        function clearMaterialFile() {
            const fileInput = document.getElementById('materialFile');
            const preview = document.getElementById('materialFilePreview');
            if (fileInput) fileInput.value = '';
            if (preview) preview.style.display = 'none';
        }

        // ========== WEBUNTIS FUNCTIONS ==========
        
        function showWebuntisForm() {
            document.getElementById('webuntisForm').style.display = 'flex';
            document.getElementById('webuntisConnectBtn').style.display = 'none';
        }

        async function loadWebuntisStatus() {
            if (!sessionId) return;
            
            try {
                const res = await fetch('/api/webuntis/status', {
                    headers: { 'x-session-id': sessionId }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    if (data.connected) {
                        document.getElementById('webuntisNotConnected').style.display = 'none';
                        document.getElementById('webuntisConnected').style.display = 'flex';
                        document.getElementById('webuntisUsernameDisplay').textContent = data.username;
                        document.getElementById('webuntisForm').style.display = 'none';
                        document.getElementById('webuntisConnectBtn').style.display = 'none';
                    } else {
                        document.getElementById('webuntisNotConnected').style.display = 'flex';
                        document.getElementById('webuntisConnected').style.display = 'none';
                        document.getElementById('webuntisForm').style.display = 'none';
                        document.getElementById('webuntisConnectBtn').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Webuntis Status Fehler:', error);
            }
        }

        async function disconnectWebuntis() {
            if (!confirm('Webuntis-Verbindung wirklich trennen?')) return;
            
            if (!sessionId) return;
            
            try {
                const res = await fetch('/api/webuntis/disconnect', {
                    method: 'DELETE',
                    headers: { 'x-session-id': sessionId }
                });
                
                if (res.ok) {
                    SoundSystem.playSuccess();
                    loadWebuntisStatus();
                } else {
                    const data = await res.json();
                    alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
                    SoundSystem.playError();
                }
            } catch (error) {
                alert('Fehler: ' + error.message);
                SoundSystem.playError();
            }
        }

        document.getElementById('webuntisForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!sessionId) {
                alert('Nicht angemeldet');
                return;
            }
            
            const server = document.getElementById('webuntisServer').value.trim();
            const school = document.getElementById('webuntisSchool').value.trim();
            const username = document.getElementById('webuntisUsernameInput').value.trim();
            const password = document.getElementById('webuntisPassword').value;
            
            if (!server || !school || !username || !password) {
                alert('Bitte f√ºlle alle Felder aus');
                return;
            }
            
            try {
                const res = await fetch('/api/webuntis/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-session-id': sessionId
                    },
                    body: JSON.stringify({ server, school, username, password })
                });
                
                if (res.ok) {
                    SoundSystem.playSuccess();
                    document.getElementById('webuntisServer').value = '';
                    document.getElementById('webuntisSchool').value = '';
                    document.getElementById('webuntisUsernameInput').value = '';
                    document.getElementById('webuntisPassword').value = '';
                    loadWebuntisStatus();
                } else {
                    const data = await res.json();
                    alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
                    SoundSystem.playError();
                }
            } catch (error) {
                alert('Fehler: ' + error.message);
                SoundSystem.playError();
            }
        });

        // ========== ADMIN ANNOUNCEMENT FUNCTIONS ==========
        
        async function loadAdminAnnouncement() {
            if (!sessionId) return;
            
            try {
                const res = await fetch('/api/admin/announcement', {
                    headers: { 'x-session-id': sessionId }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    if (data.announcement && data.announcement.message) {
                        document.getElementById('adminBanner').style.display = 'block';
                        document.getElementById('adminBannerMessage').textContent = data.announcement.message;
                    } else {
                        document.getElementById('adminBanner').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Admin Announcement Fehler:', error);
            }
        }

        async function loadAdminAnnouncementForEdit() {
            if (!sessionId || currentUser.role !== 'admin') return;
            
            try {
                const res = await fetch('/api/admin/announcement', {
                    headers: { 'x-session-id': sessionId }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    const textarea = document.getElementById('adminAnnouncementText');
                    if (textarea) {
                        textarea.value = data.announcement ? data.announcement.message : '';
                    }
                }
            } catch (error) {
                console.error('Admin Announcement Edit Fehler:', error);
            }
        }

        async function saveAdminAnnouncement() {
            if (!sessionId || currentUser.role !== 'admin') {
                alert('Nur Administratoren k√∂nnen Nachrichten setzen');
                return;
            }
            
            const message = document.getElementById('adminAnnouncementText').value.trim();
            
            if (!message) {
                alert('Bitte gib eine Nachricht ein');
                return;
            }
            
            try {
                const res = await fetch('/api/admin/announcement', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-session-id': sessionId
                    },
                    body: JSON.stringify({ message })
                });
                
                if (res.ok) {
                    SoundSystem.playSuccess();
                    alert('Admin-Nachricht erfolgreich gespeichert!');
                    loadAdminAnnouncement();
                } else {
                    const data = await res.json();
                    alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
                    SoundSystem.playError();
                }
            } catch (error) {
                alert('Fehler: ' + error.message);
                SoundSystem.playError();
            }
        }

        async function clearAdminAnnouncement() {
            if (!sessionId || currentUser.role !== 'admin') {
                alert('Nur Administratoren k√∂nnen Nachrichten l√∂schen');
                return;
            }
            
            if (!confirm('Admin-Nachricht wirklich l√∂schen?')) return;
            
            try {
                const res = await fetch('/api/admin/announcement', {
                    method: 'DELETE',
                    headers: { 'x-session-id': sessionId }
                });
                
                if (res.ok) {
                    SoundSystem.playSuccess();
                    document.getElementById('adminAnnouncementText').value = '';
                    loadAdminAnnouncement();
                    alert('Admin-Nachricht erfolgreich gel√∂scht!');
                } else {
                    const data = await res.json();
                    alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
                    SoundSystem.playError();
                }
            } catch (error) {
                alert('Fehler: ' + error.message);
                SoundSystem.playError();
            }
        }

        // PUBLIC CHAT FUNCTIONALITY
        let publicChatFiles = [];
        let publicChatPollingInterval = null;
        const PUBLIC_CHAT_POLL_INTERVAL = 3000; // 3 Sekunden
        
        // Benutzerspezifische Entwurf-Speicherung
        function getPublicChatDraftKey() {
            if (!currentUser || !currentUser.userId) return null;
            return `publicChatDraft_${currentUser.userId}`;
        }
        
        function savePublicChatDraft() {
            const input = document.getElementById('publicChatInput');
            if (!input) return;
            
            const draftKey = getPublicChatDraftKey();
            if (!draftKey) return;
            
            const draft = {
                message: input.value,
                timestamp: Date.now()
            };
            
            localStorage.setItem(draftKey, JSON.stringify(draft));
        }
        
        function loadPublicChatDraft() {
            const input = document.getElementById('publicChatInput');
            if (!input) return;
            
            const draftKey = getPublicChatDraftKey();
            if (!draftKey) {
                input.value = '';
                return;
            }
            
            try {
                const draftData = localStorage.getItem(draftKey);
                if (draftData) {
                    const draft = JSON.parse(draftData);
                    input.value = draft.message || '';
                } else {
                    input.value = '';
                }
            } catch (error) {
                console.error('Fehler beim Laden des Entwurfs:', error);
                input.value = '';
            }
        }
        
        function clearPublicChatDraft() {
            const draftKey = getPublicChatDraftKey();
            if (draftKey) {
                localStorage.removeItem(draftKey);
            }
        }
        
        function handlePublicChatFileSelect(event) {
            const files = Array.from(event.target.files);
            files.forEach((file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    publicChatFiles.push({
                        name: file.name,
                        type: file.type,
                        data: e.target.result,
                    });
                    updatePublicChatFilePreview();
                };
                reader.readAsDataURL(file);
            });
            event.target.value = '';
            SoundSystem.playFileAttach();
        }
        
        function updatePublicChatFilePreview() {
            const preview = document.getElementById('publicChatFilePreview');
            if (!preview) return;
            
            if (publicChatFiles.length === 0) {
                preview.style.display = 'none';
                preview.innerHTML = '';
                return;
            }
            
            preview.style.display = 'block';
            preview.innerHTML = publicChatFiles
                .map(
                    (file, index) => `
                <div class="file-preview-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
                    <i class="fas ${file.type.startsWith('image/') ? 'fa-image' : 'fa-file'}"></i>
                    <span style="flex: 1; font-size: 13px;">${escapeHtml(file.name)}</span>
                    <button class="file-preview-remove" onclick="removePublicChatFile(${index})" style="padding: 4px 8px; background: none; border: none; color: var(--text-secondary); cursor: pointer; border-radius: 4px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `
                )
                .join('');
        }
        
        function removePublicChatFile(index) {
            publicChatFiles.splice(index, 1);
            updatePublicChatFilePreview();
        }
        
        async function sendPublicMessage() {
            const input = document.getElementById('publicChatInput');
            const message = input.value.trim();
            if ((!message && publicChatFiles.length === 0) || !sessionId) return;
            
            SoundSystem.playSend();
            
            try {
                const formData = new FormData();
                formData.append('message', message || '');
                
                // Add files if any
                for (const file of publicChatFiles) {
                    const blob = await fetch(file.data).then(r => r.blob());
                    formData.append('files', blob, file.name);
                }
                
                const res = await fetch('/api/public-chat', {
                    method: 'POST',
                    headers: { 'x-session-id': sessionId },
                    body: formData
                });
                
                if (res.ok) {
                    input.value = '';
                    publicChatFiles = [];
                    updatePublicChatFilePreview();
                    clearPublicChatDraft(); // Entwurf nach erfolgreichem Senden l√∂schen
                    loadPublicChat();
                } else {
                    const data = await res.json();
                    alert('Fehler beim Senden: ' + (data.error || 'Unbekannter Fehler'));
                    SoundSystem.playError();
                }
            } catch (error) {
                alert('Fehler: ' + error.message);
                SoundSystem.playError();
            }
        }
        
        async function loadPublicChat() {
            if (!sessionId) return;
            try {
                const res = await fetch('/api/public-chat', {
                    headers: { 'x-session-id': sessionId }
                });
                const data = await res.json();
                if (res.ok && data.messages) {
                    renderPublicChat(data.messages);
                }
                // Entwurf nach dem Laden wiederherstellen
                loadPublicChatDraft();
            } catch (error) {
                console.error('Public chat load error:', error);
            }
        }
        
        function startPublicChatPolling() {
            // Stoppe vorhandenes Polling falls vorhanden
            stopPublicChatPolling();
            
            // Starte neues Polling
            publicChatPollingInterval = setInterval(() => {
                if (sessionId && currentUser) {
                    loadPublicChat();
                }
            }, PUBLIC_CHAT_POLL_INTERVAL);
        }
        
        function stopPublicChatPolling() {
            if (publicChatPollingInterval) {
                clearInterval(publicChatPollingInterval);
                publicChatPollingInterval = null;
            }
        }
        
        function renderPublicChat(messages) {
            const container = document.getElementById('publicChatMessages');
            if (!container) return;
            
            if (!messages || messages.length === 0) {
                container.innerHTML = '<div class="empty-state">Noch keine Nachrichten. Starte die Unterhaltung!</div>';
                return;
            }
            
            container.innerHTML = messages.map(msg => {
                const time = new Date(msg.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                const hasFile = msg.fileUrl || msg.fileName;
                const isOwnMessage = currentUser && msg.user_id === currentUser.userId;
                const deleteButton = isOwnMessage ? `
                    <button onclick="deletePublicChatMessage(${msg.id})" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px 8px; border-radius: 4px; opacity: 0.7; transition: all 0.2s;" 
                            onmouseover="this.style.opacity='1'; this.style.color='var(--error-color, #ef4444)';" 
                            onmouseout="this.style.opacity='0.7'; this.style.color='var(--text-secondary)';" 
                            title="Nachricht l√∂schen">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : '';
                
                // Profilbild oder Initial
                const avatarHtml = msg.avatarUrl 
                    ? `<img src="${escapeHtml(msg.avatarUrl)}" alt="${escapeHtml(msg.username || '')}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color);" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />`
                    : '';
                const avatarInitial = `<div style="width: 32px; height: 32px; border-radius: 50%; background: var(--accent-color); color: white; display: ${msg.avatarUrl ? 'none' : 'flex'}; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; border: 2px solid var(--border-color);">${(msg.username || 'U').charAt(0).toUpperCase()}</div>`;
                
                return `
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color); position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                ${avatarHtml}
                                ${avatarInitial}
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 2px;">
                                        <strong>${escapeHtml(msg.username || 'Unbekannt')}</strong>
                                        <span style="font-size: 12px; color: var(--text-secondary);">${time}</span>
                                    </div>
                                </div>
                            </div>
                            ${deleteButton}
                        </div>
                        ${msg.message ? `<div style="margin-left: 42px; margin-bottom: 8px;">${escapeHtml(msg.message)}</div>` : ''}
                        ${hasFile ? `
                            <div style="margin-left: 42px; margin-top: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 6px;">
                                <i class="fas ${msg.fileType?.startsWith('image/') ? 'fa-image' : 'fa-file'}"></i>
                                ${msg.fileUrl ? `<a href="${escapeHtml(msg.fileUrl)}" target="_blank" style="margin-left: 8px; color: var(--accent-color);">${escapeHtml(msg.fileName || 'Datei')}</a>` : escapeHtml(msg.fileName || 'Datei')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            const chatContainer = document.getElementById('publicChatContainer');
            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        async function deletePublicChatMessage(messageId) {
            if (!confirm('Nachricht wirklich l√∂schen?')) {
                return;
            }

            if (!sessionId) {
                alert('Nicht angemeldet');
                return;
            }

            try {
                const res = await fetch(`/api/public-chat/${messageId}`, {
                    method: 'DELETE',
                    headers: { 'x-session-id': sessionId }
                });

                if (res.ok) {
                    SoundSystem.playDelete();
                    loadPublicChat();
                } else {
                    const data = await res.json();
                    alert('Fehler beim L√∂schen: ' + (data.error || 'Unbekannter Fehler'));
                    SoundSystem.playError();
                }
            } catch (error) {
                alert('Fehler: ' + error.message);
                SoundSystem.playError();
            }
        }
        
        // Load public chat on page load and set up enter key
        if (document.getElementById('publicChatInput')) {
            const publicChatInput = document.getElementById('publicChatInput');
            
            // Enter-Taste zum Senden
            publicChatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendPublicMessage();
                }
            });
            
            // Auto-Save Entwurf beim Tippen
            publicChatInput.addEventListener('input', () => {
                savePublicChatDraft();
            });
            
            // Entwurf beim Laden wiederherstellen
            loadPublicChatDraft();
        }

        window.addEventListener('resize', handleResponsiveLayout);

        // INIT - Wait for DOM to be ready
        // Initialize mobile UI fixes immediately
        if (window.innerWidth <= 768) {
            fixMobileUI();
        }
        
        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                fixMobileUI();
            }, 250);
        });
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initLoginForm();
                initMainNavigation();
                initHomeInteractions();
                checkSession();
                handleResponsiveLayout();
                updateSidebarToggleBtn();
                fixMobileUI(); // Ensure mobile UI is fixed on load
            });
        } else {
            // DOM is already loaded
            initLoginForm();
            initMainNavigation();
            initHomeInteractions();
            checkSession();
            handleResponsiveLayout();
            updateSidebarToggleBtn();
            fixMobileUI(); // Ensure mobile UI is fixed on load
        }
    </script>
</body>
</html>
